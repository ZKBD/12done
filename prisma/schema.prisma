// 12done.com Database Schema
// Comprehensive Real Estate & Services Platform
// Phase 1: User Management, Properties, Search

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  AGENT // Real estate agent (PROD-026)
  ADMIN
}

enum UserStatus {
  PENDING_VERIFICATION // Email not verified yet
  PENDING_PROFILE // Email verified, profile incomplete
  ACTIVE // Fully registered
  SUSPENDED
  DELETED
}

enum VerificationStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

// ID Document Type (PROD-008.3)
enum DocumentType {
  PASSPORT
  DRIVERS_LICENSE
  NATIONAL_ID
}

// Background Check Type (PROD-009)
enum BackgroundCheckType {
  BASIC // Criminal records only
  STANDARD // Criminal + employment
  COMPREHENSIVE // Criminal + employment + credit
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ListingType {
  FOR_SALE
  SHORT_TERM_RENT
  LONG_TERM_RENT
  EVENTS
  BARTER
}

enum PropertyStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD
  RENTED
  EXPIRED
  DELETED
}

enum EnergyEfficiencyRating {
  A_PLUS_PLUS
  A_PLUS
  A
  B
  C
  D
  E
  F
  G
  NOT_RATED
}

// AI Description Generation (PROD-029)
enum DescriptionTone {
  LUXURY
  FAMILY_FRIENDLY
  INVESTMENT_FOCUSED
  MODERN_PROFESSIONAL
  COZY_WELCOMING
}

enum NotificationType {
  EMAIL_VERIFICATION
  WELCOME
  PASSWORD_RESET
  SEARCH_AGENT_MATCH
  INVITATION_SENT
  INVITATION_ACCEPTED
  PROPERTY_INQUIRY
  INSPECTION_BOOKED
  INSPECTION_REMINDER
  NEGOTIATION_STARTED
  OFFER_RECEIVED
  OFFER_ACCEPTED
  OFFER_REJECTED
  OFFER_COUNTERED
  PAYMENT_RECEIVED
  PAYMENT_CONFIRMED
  PAYMENT_FAILED
  REFUND_PROCESSED
  REFUND_CONFIRMED
  // Rental Applications (PROD-101)
  APPLICATION_RECEIVED
  APPLICATION_STATUS_CHANGED
  APPLICATION_WITHDRAWN
  // Rent Reminders (PROD-102)
  RENT_REMINDER_TENANT
  RENT_PAYMENT_RECEIVED
  RENT_OVERDUE_TENANT
  RENT_OVERDUE_LANDLORD
  // Maintenance Requests (PROD-103)
  MAINTENANCE_REQUEST_SUBMITTED
  MAINTENANCE_REQUEST_APPROVED
  MAINTENANCE_REQUEST_REJECTED
  MAINTENANCE_REQUEST_ASSIGNED
  MAINTENANCE_REQUEST_SCHEDULED
  MAINTENANCE_REQUEST_COMPLETED
  MAINTENANCE_REQUEST_CONFIRMED
  // Lease Renewals (PROD-105)
  LEASE_RENEWAL_REMINDER_LANDLORD
  LEASE_RENEWAL_OFFER_TENANT
  LEASE_RENEWAL_ACCEPTED
  LEASE_RENEWAL_DECLINED
  LEASE_RENEWAL_EXPIRED
  // Tenant Portal (PROD-106)
  LEASE_SIGNED_BY_LANDLORD
  LEASE_SIGNED_BY_TENANT
  LEASE_FULLY_EXECUTED
  DOCUMENT_UPLOADED
  // Messaging (PROD-200)
  MESSAGE_RECEIVED
}

// ============================================
// NEGOTIATIONS & TRANSACTIONS (PROD-090 to PROD-095)
// ============================================

enum NegotiationType {
  BUY // Purchasing property
  RENT // Renting property (short or long term)
}

enum NegotiationStatus {
  ACTIVE // Negotiation is ongoing
  ACCEPTED // Final offer accepted
  REJECTED // Negotiation rejected/cancelled
  COMPLETED // Transaction completed
  EXPIRED // Negotiation timed out
}

enum OfferStatus {
  PENDING // Awaiting response
  ACCEPTED // Offer accepted
  REJECTED // Offer rejected
  COUNTERED // Counter-offer made
  EXPIRED // Offer expired
  WITHDRAWN // Offer withdrawn by maker
}

enum TransactionStatus {
  PENDING // Payment not yet initiated
  PROCESSING // Payment in progress
  COMPLETED // Payment successful
  FAILED // Payment failed
  REFUNDED // Payment refunded
  CANCELLED // Transaction cancelled
}

// ============================================
// MESSAGING (In-App Communication)
// ============================================

enum MessageType {
  TEXT // Regular user message
  SYSTEM // System-generated message (e.g., "Offer accepted")
}

// ============================================
// SERVICE PROVIDERS (PROD-060 to PROD-068)
// ============================================

enum ServiceType {
  LAWYER
  CLEANER
  HANDYMAN
  PROPERTY_SHOWING
  RECEPTIONIST
}

enum ServiceProviderStatus {
  PENDING // Application submitted, awaiting review
  APPROVED // Approved by admin
  REJECTED // Rejected by admin
  SUSPENDED // Temporarily suspended
  INACTIVE // Provider chose to deactivate
}

enum ServiceRequestStatus {
  PENDING // Request sent, awaiting provider response
  ACCEPTED // Provider accepted the job
  REJECTED // Provider declined
  IN_PROGRESS // Job is being performed
  COMPLETED // Job completed
  CANCELLED // Request cancelled
}

// ============================================
// RENTAL APPLICATIONS (PROD-101)
// ============================================

enum ApplicationStatus {
  PENDING // Application submitted, awaiting review
  UNDER_REVIEW // Owner is reviewing the application
  APPROVED // Application approved
  REJECTED // Application rejected
  WITHDRAWN // Applicant withdrew the application
}

// ============================================
// LEASES & RENT PAYMENTS (PROD-102)
// ============================================

enum LeaseStatus {
  DRAFT // Lease created but not yet active
  ACTIVE // Currently active lease
  EXPIRED // Lease has ended naturally
  TERMINATED // Lease was terminated early
}

enum RentPaymentStatus {
  PENDING // Payment is expected
  PAID // Payment received
  OVERDUE // Payment is past due date
  WAIVED // Payment was waived by landlord
}

// ============================================
// LEASE RENEWALS (PROD-105)
// ============================================

enum LeaseRenewalStatus {
  PENDING // 60-day window opened, awaiting landlord action
  OFFERED // Landlord created offer, awaiting tenant response
  ACCEPTED // Tenant accepted, new lease generated
  DECLINED // Tenant declined the offer
  EXPIRED // Offer expired without response
  CANCELLED // Landlord cancelled the offer
}

// ============================================
// MAINTENANCE REQUESTS (PROD-103)
// ============================================

enum MaintenanceRequestType {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  CLEANING
  LANDSCAPING
  OTHER
}

enum MaintenanceRequestStatus {
  SUBMITTED // Tenant submitted, awaiting landlord review
  APPROVED // Landlord approved, ready for assignment
  REJECTED // Landlord rejected with reason
  ASSIGNED // Provider assigned, awaiting scheduling
  SCHEDULED // Date/time confirmed
  IN_PROGRESS // Work started
  COMPLETED // Work finished, awaiting confirmation
  CONFIRMED // Both parties confirmed completion
  CANCELLED // Request cancelled
}

enum MaintenancePriority {
  LOW
  NORMAL
  URGENT
  EMERGENCY
}

// ============================================
// LANDLORD EXPENSES (PROD-100.4)
// ============================================

enum ExpenseCategory {
  MAINTENANCE // Repairs and upkeep
  INSURANCE // Property insurance
  TAXES // Property taxes
  UTILITIES // Utilities paid by landlord
  MORTGAGE // Mortgage payments
  MANAGEMENT_FEES // Property management fees
  LEGAL // Legal expenses
  ADVERTISING // Marketing and advertising
  SUPPLIES // Supplies and materials
  TRAVEL // Travel expenses for property visits
  OTHER // Miscellaneous
}

// ============================================
// USER MANAGEMENT (PROD-001 to PROD-011)
// ============================================

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  firstName    String
  lastName     String
  phone        String? // International format (PROD-002)
  address      String? // (PROD-002)
  postalCode   String? // (PROD-002)
  city         String? // (PROD-002)
  country      String? // ISO 3166-1 alpha-2 (PROD-002)
  role         UserRole   @default(USER) // (PROD-004)
  status       UserStatus @default(PENDING_VERIFICATION)

  // Email verification (PROD-001)
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  // ID Verification (PROD-008, PROD-010)
  idVerificationStatus VerificationStatus @default(NOT_STARTED)
  idVerifiedAt         DateTime?

  // Background Check (PROD-009)
  backgroundCheckStatus VerificationStatus @default(NOT_STARTED)
  backgroundCheckAt     DateTime?

  // Social Media Profiles (PROD-005)
  socialProfiles SocialProfile[]

  // Invitation System (PROD-006, PROD-007)
  invitedById        String?
  invitedBy          User?        @relation("InvitedBy", fields: [invitedById], references: [id])
  invitees           User[]       @relation("InvitedBy")
  sentInvitations    Invitation[] @relation("SentInvitations")
  receivedInvitation Invitation?  @relation("ReceivedInvitation")

  // Properties (PROD-020+)
  properties Property[]

  // Search & Favorites (PROD-040+)
  searchAgents           SearchAgent[]
  favoriteProperties     FavoriteProperty[]
  browsingHistory        BrowsingHistory[]
  recommendationFeedback RecommendationFeedback[]

  // Notifications (USER-020+)
  notifications Notification[]

  // Auth Tokens
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  refreshTokens           RefreshToken[]

  // Inspection bookings
  bookedInspections InspectionSlot[]

  // Negotiations & Transactions (PROD-090+)
  buyerNegotiations  Negotiation[] @relation("BuyerNegotiations")
  sellerNegotiations Negotiation[] @relation("SellerNegotiations")
  madeOffers         Offer[]
  transactions       Transaction[]

  // Messaging
  conversationParticipants ConversationParticipant[]
  messagesSent             Message[]

  // Service Providers (PROD-060+)
  serviceProviderProfiles ServiceProvider[]
  serviceRequests         ServiceRequest[]
  providerReviews         ProviderReview[]

  // Rental Applications (PROD-101)
  rentalApplications RentalApplication[]

  // Leases (PROD-102)
  tenantLeases   Lease[] @relation("TenantLeases")
  landlordLeases Lease[] @relation("LandlordLeases")

  // Maintenance Requests (PROD-103)
  tenantMaintenanceRequests   MaintenanceRequest[] @relation("TenantMaintenanceRequests")
  landlordMaintenanceRequests MaintenanceRequest[] @relation("LandlordMaintenanceRequests")

  // Lease Renewals (PROD-105)
  landlordLeaseRenewals LeaseRenewal[] @relation("LandlordLeaseRenewals")
  tenantLeaseRenewals   LeaseRenewal[] @relation("TenantLeaseRenewals")

  // Landlord Expenses (PROD-100.4)
  expenses Expense[] @relation("LandlordExpenses")

  // AI Tour Guide (PROD-120+)
  tourPreferences TourPreferences?
  savedPlaces     SavedPlace[]
  customTours     CustomTour[]
  userNotes       UserNote[]

  // Identity Verification (PROD-008)
  verificationRequests VerificationRequest[]
  backgroundChecks     BackgroundCheck[]

  // Platform Services (PROD-080-082)
  insuranceProvider InsuranceProvider?
  mortgageProvider  MortgageProvider?
  providerInquiries ProviderInquiry[]

  // Financial Tools (PROD-160-169)
  investmentPortfolios InvestmentPortfolio[]
  taxReports           TaxReport[]

  // Profit-Sharing (Revenue Distribution)
  wallet UserWallet?

  // Stay Planning (PROD-140-144)
  stayPlanningSessions StayPlanningSession[]
  tripPlans            TripPlan[]
  attractionBookings   AttractionBooking[]
  cateringQuotes       CateringQuote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([invitedById])
  @@index([status])
  @@index([role])
}

// Social Media Profiles (PROD-005)
model SocialProfile {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform   String // facebook, instagram, linkedin, twitter, etc.
  profileUrl String
  createdAt  DateTime @default(now())

  @@unique([userId, platform])
  @@index([userId])
}

// ============================================
// IDENTITY VERIFICATION (PROD-008)
// ============================================
model VerificationRequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Document details (PROD-008.1, PROD-008.3)
  documentType DocumentType
  documentUrl  String // Secure S3 URL (PROD-008.4)
  selfieUrl    String? // Optional selfie for liveness check

  // Verification status
  status VerificationStatus @default(PENDING)

  // Admin review (PROD-008.5, PROD-008.6)
  reviewedById String?
  reviewedAt   DateTime?
  rejectionReason String?

  // Timestamps
  submittedAt DateTime @default(now())
  expiresAt   DateTime? // Document expiry date if provided

  @@index([userId])
  @@index([status])
  @@index([submittedAt])
}

// ============================================
// BACKGROUND CHECKS (PROD-009)
// ============================================
model BackgroundCheck {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Check details (PROD-009.1)
  type      BackgroundCheckType
  status    VerificationStatus @default(PENDING)
  reportUrl String? // Secure URL to full report (PROD-009.4)

  // Provider reference (PROD-009.3)
  providerName      String? // e.g., "Checkr", "Sterling"
  providerReference String? // External ID from provider

  // Consent (PROD-009.5)
  consentGivenAt DateTime?
  consentIpAddress String?

  // Results summary (stored securely)
  resultSummary String? // High-level: "CLEAR", "REVIEW", "FLAGGED"

  // Timestamps
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // Validity period

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
}

// Email Verification Token (PROD-001)
model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

// Password Reset Token
model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

// JWT Refresh Token
model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

// ============================================
// INVITATION SYSTEM (PROD-006, PROD-007)
// ============================================

model Invitation {
  id        String           @id @default(uuid())
  email     String
  inviterId String
  inviter   User             @relation("SentInvitations", fields: [inviterId], references: [id])
  status    InvitationStatus @default(PENDING)
  token     String           @unique

  // Track if invitation converted to user
  acceptedUserId String? @unique
  acceptedUser   User?   @relation("ReceivedInvitation", fields: [acceptedUserId], references: [id])

  // Kick-back eligibility tracking (PROD-006)
  kickbackEligible Boolean @default(true)

  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([email])
  @@index([token])
  @@index([inviterId])
  @@index([status])
}

// ============================================
// PROPERTY LISTINGS (PROD-020 to PROD-031)
// ============================================

model Property {
  id      String @id @default(uuid())
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  // Location (PROD-020)
  address    String
  postalCode String
  city       String
  country    String // ISO 3166-1 alpha-2
  latitude   Float?
  longitude  Float?

  // Basic Info (PROD-021)
  title                  String
  description            String?
  aiGeneratedDescription String? // (PROD-029)
  descriptionTone        DescriptionTone? // (PROD-029)

  // Listing Types (PROD-022) - Multi-choice stored as array
  listingTypes ListingType[]

  // Pricing (PROD-021, PROD-023)
  basePrice             Decimal  @db.Decimal(12, 2)
  currency              String   @default("EUR")
  priceNegotiable       Boolean  @default(false)
  negotiabilityRange    Decimal? @db.Decimal(5, 2) // Percentage, e.g., 10.00 = 10%
  dynamicPricingEnabled Boolean  @default(false)

  // Dimensions & Characteristics (PROD-021, PROD-027)
  squareMeters Float?
  lotSize      Float? // (PROD-042)
  bedrooms     Int?
  bathrooms    Int?
  floors       Int?
  yearBuilt    Int? // (PROD-042)

  // Property Details (PROD-027)
  energyEfficiency     EnergyEfficiencyRating @default(NOT_RATED)
  energyCertificateUrl String?
  hoaFees              Decimal?               @db.Decimal(10, 2)
  hoaInfo              String?
  propertyTaxHistory   Json? // Array of {year, amount}
  utilitiesCostHistory Json? // Array of {month, electricity, gas, water}

  // Features (PROD-042)
  petFriendly Boolean @default(false)
  newlyBuilt  Boolean @default(false)
  accessible  Boolean @default(false)

  // No Agents Tag (PROD-026)
  noAgents Boolean @default(false)

  // Status
  status      PropertyStatus @default(DRAFT)
  publishedAt DateTime?

  // Relations
  media                  PropertyMedia[]
  floorPlans             FloorPlan[]
  availabilitySlots      AvailabilitySlot[]
  inspectionSlots        InspectionSlot[]
  openHouseEvents        OpenHouseEvent[] // (PROD-048)
  dynamicPricingRules    DynamicPricingRule[]
  favoritedBy            FavoriteProperty[]
  browsingHistory        BrowsingHistory[]
  recommendationFeedback RecommendationFeedback[]
  negotiations           Negotiation[] // (PROD-090)
  conversations          Conversation[] // Direct property inquiries
  serviceRequests        ServiceRequest[] // Service requests for this property
  rentalApplications     RentalApplication[] // Rental applications (PROD-101)
  leases                 Lease[] // Leases (PROD-102)
  maintenanceRequests    MaintenanceRequest[] // Maintenance requests (PROD-103)
  expenses               Expense[] // Landlord expenses (PROD-100.4)
  providerInquiries      ProviderInquiry[] // Platform provider inquiries (PROD-082)

  // Financial Tools (PROD-160-169)
  valuations          PropertyValuation[]
  priceHistory        PriceHistory[]
  portfolioEntries    PortfolioProperty[]
  cashFlowProjections CashFlowProjection[]

  // Stay Planning (PROD-140-144)
  stayPlanningSessions StayPlanningSession[]
  tripPlans            TripPlan[]
  cateringQuotes       CateringQuote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([city])
  @@index([country])
  @@index([status])
  @@index([listingTypes])
  @@index([basePrice])
  @@index([latitude, longitude])
}

// Room Type for Virtual Staging (PROD-030)
enum RoomType {
  LIVING_ROOM
  BEDROOM
  KITCHEN
  BATHROOM
  DINING_ROOM
  OFFICE
  BALCONY
  GARAGE
  HALLWAY
  BASEMENT
  ATTIC
  OUTDOOR
  OTHER
}

// Staging Style (PROD-030)
enum StagingStyle {
  MODERN
  TRADITIONAL
  MINIMALIST
  SCANDINAVIAN
  INDUSTRIAL
  BOHEMIAN
  COASTAL
  FARMHOUSE
  MID_CENTURY
  CONTEMPORARY
  RUSTIC
  LUXURY
}

// Time of Day (PROD-031)
enum TimeOfDay {
  DAWN
  MORNING
  NOON
  AFTERNOON
  DUSK
  NIGHT
}

// Season (PROD-031)
enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
}

// Staging Request Status (PROD-030)
enum StagingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Property Media (PROD-028)
model PropertyMedia {
  id           String   @id @default(uuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  type         String // photo, video, tour_360, tour_3d
  url          String
  thumbnailUrl String?
  caption      String?
  sortOrder    Int      @default(0)
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Virtual Staging (PROD-030)
  isVirtuallyStaged Boolean       @default(false)
  roomType          RoomType?
  stagingStyle      StagingStyle?
  originalMediaId   String?       // Reference to original unstaged photo

  // Time-of-Day Photos (PROD-031)
  timeOfDay    TimeOfDay?
  season       Season?
  photoGroupId String?    // Group photos of same angle at different times/seasons

  @@index([propertyId])
  @@index([type])
  @@index([isVirtuallyStaged])
  @@index([photoGroupId])
}

// Virtual Staging Request (PROD-030)
model VirtualStagingRequest {
  id              String        @id @default(uuid())
  propertyId      String
  originalMediaId String        // The original PropertyMedia being staged
  roomType        RoomType
  style           StagingStyle
  status          StagingStatus @default(PENDING)

  // Result
  stagedMediaId String? // The resulting staged PropertyMedia
  stagedUrl     String? // URL of staged image (before creating PropertyMedia)

  // Provider tracking
  providerName      String? // "MockProvider", "REimagine", etc.
  providerRequestId String? // External provider's request ID

  // Error handling
  errorMessage String?

  // Timestamps
  requestedById String
  createdAt     DateTime  @default(now())
  completedAt   DateTime?

  @@index([propertyId])
  @@index([status])
  @@index([requestedById])
}

// Floor Plans (PROD-027)
model FloorPlan {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  name       String // "Ground Floor", "First Floor", etc.
  imageUrl   String
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  @@index([propertyId])
}

// Availability Calendar (PROD-024)
model AvailabilitySlot {
  id            String   @id @default(uuid())
  propertyId    String
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  startDate     DateTime
  endDate       DateTime
  isAvailable   Boolean  @default(true)
  pricePerNight Decimal? @db.Decimal(10, 2) // For short-term rentals
  notes         String?
  createdAt     DateTime @default(now())

  @@index([propertyId])
  @@index([startDate, endDate])
  @@index([isAvailable])
}

// Inspection Scheduling (PROD-025)
model InspectionSlot {
  id         String    @id @default(uuid())
  propertyId String
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  date       DateTime
  startTime  String // "09:00"
  endTime    String // "09:30"
  isBooked   Boolean   @default(false)
  bookedById String?
  bookedBy   User?     @relation(fields: [bookedById], references: [id])
  bookedAt   DateTime?
  createdAt  DateTime  @default(now())

  @@index([propertyId])
  @@index([date])
  @@index([isBooked])
}

// Open House Events (PROD-048)
model OpenHouseEvent {
  id           String   @id @default(uuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  date         DateTime // The date of the open house
  startTime    String // "10:00"
  endTime      String // "14:00"
  description  String? // Optional details like "Refreshments provided"
  isPublic     Boolean  @default(true) // Whether visible to all users
  maxAttendees Int? // Optional capacity limit
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([propertyId])
  @@index([date])
}

// Dynamic Pricing Rules (PROD-023)
model DynamicPricingRule {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  name            String // "Summer Season", "Holiday Premium", "Weekend Rate"
  startDate       DateTime?
  endDate         DateTime?
  dayOfWeek       Int? // 0-6 (Sunday-Saturday) for recurring weekly rules
  priceMultiplier Decimal   @db.Decimal(4, 2) // 1.20 = 20% increase, 0.80 = 20% discount
  isActive        Boolean   @default(true)
  priority        Int       @default(0) // Higher priority rules applied first
  createdAt       DateTime  @default(now())

  @@index([propertyId])
  @@index([isActive])
}

// ============================================
// SEARCH & DISCOVERY (PROD-040 to PROD-050)
// ============================================

// Search Agent (PROD-040, PROD-041)
model SearchAgent {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  name   String

  // Search Criteria (PROD-040, PROD-042) - Flexible JSON structure
  // Example: { listingTypes: ["FOR_SALE"], country: "HU", minPrice: 100000, maxPrice: 500000, ... }
  criteria Json

  // Notifications (PROD-041)
  emailNotifications Boolean @default(true)
  inAppNotifications Boolean @default(true)

  isActive        Boolean   @default(true)
  lastTriggeredAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([isActive])
}

// Favorite Properties (PROD-049)
model FavoriteProperty {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

// Browsing History for AI Recommendations (PROD-050)
model BrowsingHistory {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  viewedAt   DateTime @default(now())
  duration   Int? // Seconds spent viewing

  @@index([userId])
  @@index([propertyId])
  @@index([viewedAt])
}

// Recommendation Feedback (PROD-050)
model RecommendationFeedback {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  isPositive Boolean // true = thumbs up, false = thumbs down
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId])
  @@index([userId])
}

// ============================================
// RENTAL APPLICATIONS (PROD-101)
// ============================================

// Rental Application (PROD-101.2 to PROD-101.6)
model RentalApplication {
  id String @id @default(uuid())

  // Applicant (user applying for the property)
  applicantId String
  applicant   User   @relation(fields: [applicantId], references: [id])

  // Property being applied for
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Application status (PROD-101.5)
  status ApplicationStatus @default(PENDING)

  // Employment Information (PROD-101.6)
  employmentStatus   String? // "employed", "self-employed", "unemployed", "retired", "student"
  employer           String?
  jobTitle           String?
  monthlyIncome      Decimal? @db.Decimal(12, 2)
  incomeCurrency     String   @default("EUR")
  employmentDuration String? // e.g., "2 years", "6 months"

  // References (PROD-101.6)
  // JSON array: [{ name, relationship, phone, email }]
  references Json?

  // Rental Details
  desiredMoveInDate DateTime?
  desiredLeaseTerm  Int? // Months
  numberOfOccupants Int?
  hasPets           Boolean   @default(false)
  petDetails        String?
  additionalNotes   String?

  // Supporting Documents
  // JSON array: [{ type, url, name }] - e.g., pay stubs, ID, etc.
  documents Json?

  // Owner Response
  ownerNotes String?
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // One application per user per property
  @@unique([applicantId, propertyId])
  @@index([applicantId])
  @@index([propertyId])
  @@index([status])
}

// ============================================
// LEASES (PROD-102)
// ============================================

// Lease Agreement (PROD-102.1)
model Lease {
  id String @id @default(uuid())

  // Property being leased
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Tenant (renter)
  tenantId String
  tenant   User   @relation("TenantLeases", fields: [tenantId], references: [id])

  // Landlord (property owner)
  landlordId String
  landlord   User   @relation("LandlordLeases", fields: [landlordId], references: [id])

  // Lease terms
  startDate  DateTime
  endDate    DateTime
  rentAmount Decimal  @db.Decimal(12, 2)
  currency   String   @default("EUR")
  dueDay     Int // 1-28 day of month when rent is due

  // Security deposit
  securityDeposit     Decimal? @db.Decimal(12, 2)
  securityDepositPaid Boolean  @default(false)

  // Status
  status LeaseStatus @default(DRAFT)

  // Optional document
  documentUrl String?

  // E-Signature tracking (PROD-106.6)
  landlordSignedAt    DateTime? // When landlord signed
  tenantSignedAt      DateTime? // When tenant signed
  landlordSignatureIp String? // IP address for audit trail
  tenantSignatureIp   String? // IP address for audit trail

  // Relations
  rentPayments        RentPayment[]
  maintenanceRequests MaintenanceRequest[] // Maintenance requests (PROD-103)
  renewals            LeaseRenewal[] // Lease renewals (PROD-105)
  renewedFromRenewal  LeaseRenewal?        @relation("RenewalNewLease") // Renewal that created this lease
  documents           TenantDocument[] // Tenant documents (PROD-106.7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([tenantId])
  @@index([landlordId])
  @@index([status])
}

// Rent Payment Tracking (PROD-102.2 to PROD-102.6)
model RentPayment {
  id String @id @default(uuid())

  // Associated lease
  leaseId String
  lease   Lease  @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  // Payment details
  dueDate  DateTime
  amount   Decimal  @db.Decimal(12, 2)
  currency String   @default("EUR")

  // Status
  status RentPaymentStatus @default(PENDING)

  // Payment info (when paid)
  paidAt         DateTime?
  paidAmount     Decimal?  @db.Decimal(12, 2)
  paymentMethod  String? // "bank_transfer", "cash", "card", etc.
  transactionRef String? // External reference number

  // Notification tracking
  reminderSentAt DateTime? // When 5-day reminder was sent
  overdueSentAt  DateTime? // When overdue notification was sent

  // Notes
  notes String?

  // Split payment (PROD-096)
  splitPayment SplitPayment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leaseId, dueDate]) // One payment per due date per lease
  @@index([leaseId])
  @@index([dueDate])
  @@index([status])
}

// ============================================
// NOTIFICATIONS (USER-020 to USER-023)
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json? // Additional context (propertyId, invitationId, etc.)
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// LOCALIZATION (USER-030 to USER-034, USER-040)
// ============================================

model Country {
  code        String  @id // ISO 3166-1 alpha-2
  name        String
  nativeName  String? // Name in local language
  phonePrefix String // "+1", "+44", "+36", etc.
  currency    String // ISO 4217 currency code
  isActive    Boolean @default(true)

  @@index([isActive])
}

// ============================================
// NEGOTIATIONS & TRANSACTIONS (PROD-090 to PROD-095)
// ============================================

// Negotiation (PROD-090)
model Negotiation {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Parties
  buyerId  String // The interested party (buyer/renter)
  buyer    User   @relation("BuyerNegotiations", fields: [buyerId], references: [id])
  sellerId String // The property owner
  seller   User   @relation("SellerNegotiations", fields: [sellerId], references: [id])

  // Negotiation details
  type   NegotiationType // BUY or RENT
  status NegotiationStatus @default(ACTIVE)

  // For rentals
  startDate DateTime? // Rental start date
  endDate   DateTime? // Rental end date

  // Message/notes
  initialMessage String? // Initial message from buyer

  // Relations
  offers       Offer[]
  transaction  Transaction?
  conversation Conversation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([type])
}

// Offer (PROD-090)
model Offer {
  id            String      @id @default(uuid())
  negotiationId String
  negotiation   Negotiation @relation(fields: [negotiationId], references: [id], onDelete: Cascade)

  // Who made this offer
  madeById String
  madeBy   User   @relation(fields: [madeById], references: [id])

  // Offer details
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("EUR")

  // Terms (flexible JSON for additional conditions)
  terms   Json? // { "moveInDate": "2024-01-15", "includesFurniture": true, ... }
  message String? // Message accompanying the offer

  // Status tracking
  status      OfferStatus @default(PENDING)
  expiresAt   DateTime? // Optional expiry for the offer
  respondedAt DateTime? // When seller/buyer responded

  // Counter-offer reference
  counterToId String? // If this is a counter-offer, reference to original offer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([negotiationId])
  @@index([madeById])
  @@index([status])
}

// Transaction (PROD-093, PROD-095)
model Transaction {
  id            String      @id @default(uuid())
  negotiationId String      @unique
  negotiation   Negotiation @relation(fields: [negotiationId], references: [id])

  // Payment details
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("EUR")

  // Fee breakdown (PROD-095)
  platformFee     Decimal @db.Decimal(10, 2) // Platform's fee
  platformFeeRate Decimal @db.Decimal(5, 4) // e.g., 0.0250 = 2.5%
  sellerAmount    Decimal @db.Decimal(12, 2) // Amount seller receives

  // Stripe integration (PROD-094)
  stripePaymentIntentId String? @unique
  stripeSessionId       String?

  // Status
  status TransactionStatus @default(PENDING)

  // Payer info
  payerId String
  payer   User   @relation(fields: [payerId], references: [id])

  // Timestamps
  paidAt     DateTime?
  failedAt   DateTime?
  refundedAt DateTime?

  // Split payment (PROD-096)
  splitPayment SplitPayment?

  // Escrow (PROD-097)
  escrow Escrow?

  // Revenue Distribution (Profit-Sharing)
  revenueDistribution RevenueDistribution?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([negotiationId])
  @@index([payerId])
  @@index([status])
  @@index([stripePaymentIntentId])
}

// ============================================
// SPLIT PAYMENTS (PROD-096)
// ============================================

enum SplitPaymentStatus {
  PENDING // Waiting for all participants
  PARTIAL // Some payments received
  COMPLETED // All payments received
  CANCELLED // Split cancelled
  EXPIRED // Payment deadline passed
}

enum ParticipantPaymentStatus {
  PENDING // Not yet paid
  PAID // Payment received
  FAILED // Payment failed
  REFUNDED // Payment refunded
}

model SplitPayment {
  id String @id @default(uuid())

  // Link to rent payment or transaction
  rentPaymentId String? @unique
  rentPayment   RentPayment? @relation(fields: [rentPaymentId], references: [id], onDelete: SetNull)

  transactionId String? @unique
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  // Split details (PROD-096.1)
  totalAmount Decimal @db.Decimal(12, 2)
  currency    String  @default("EUR")

  // Status tracking (PROD-096.4)
  status      SplitPaymentStatus @default(PENDING)
  paidAmount  Decimal            @db.Decimal(12, 2) @default(0)
  paidCount   Int                @default(0)

  // Deadline
  expiresAt DateTime?

  // Created by
  createdById String

  // Participants
  participants SplitPaymentParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdById])
}

model SplitPaymentParticipant {
  id String @id @default(uuid())

  splitPaymentId String
  splitPayment   SplitPayment @relation(fields: [splitPaymentId], references: [id], onDelete: Cascade)

  // Participant info (PROD-096.2)
  email     String
  name      String?
  userId    String? // If registered user

  // Amount to pay (PROD-096.2)
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("EUR")

  // Individual payment link (PROD-096.3)
  paymentToken   String @unique @default(uuid())
  paymentLinkUrl String?

  // Stripe session for this participant
  stripeSessionId String?

  // Status (PROD-096.4)
  status ParticipantPaymentStatus @default(PENDING)
  paidAt DateTime?

  // Reminder tracking
  reminderSentAt DateTime?
  reminderCount  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([splitPaymentId])
  @@index([email])
  @@index([paymentToken])
  @@index([status])
}

// ============================================
// ESCROW SERVICES (PROD-097)
// ============================================

enum EscrowStatus {
  PENDING // Created but not funded
  FUNDED // Money deposited
  PARTIAL_RELEASE // Some milestones released
  RELEASED // All funds released
  DISPUTED // Under dispute
  REFUNDED // Funds returned to buyer
  CANCELLED // Escrow cancelled
}

enum EscrowMilestoneStatus {
  PENDING // Not yet completed
  COMPLETED // Milestone achieved
  APPROVED // Approved for release
  RELEASED // Funds released
  DISPUTED // Under dispute
}

model Escrow {
  id String @id @default(uuid())

  // Link to transaction (PROD-097.1)
  transactionId String @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // Escrow amounts
  totalAmount  Decimal @db.Decimal(12, 2)
  heldAmount   Decimal @db.Decimal(12, 2) @default(0)
  releasedAmount Decimal @db.Decimal(12, 2) @default(0)
  currency     String  @default("EUR")

  // Threshold (PROD-097.2)
  // Only require escrow for transactions above this amount
  thresholdAmount Decimal? @db.Decimal(12, 2)

  // Status (PROD-097.3)
  status EscrowStatus @default(PENDING)

  // Provider reference (PROD-097.1)
  providerName      String? // "Stripe", "Escrow.com", etc.
  providerReference String?

  // Parties
  buyerId  String
  sellerId String

  // Timestamps
  fundedAt   DateTime?
  releasedAt DateTime?
  disputedAt DateTime?

  // Milestones
  milestones EscrowMilestone[]

  // Disputes
  disputes EscrowDispute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([buyerId])
  @@index([sellerId])
}

model EscrowMilestone {
  id String @id @default(uuid())

  escrowId String
  escrow   Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  // Milestone details (PROD-097.4)
  title       String
  description String?
  amount      Decimal @db.Decimal(12, 2)
  currency    String  @default("EUR")

  // Order for sequential release
  orderIndex Int @default(0)

  // Conditions for release (PROD-097.4)
  conditions String? // JSON or text description

  // Status
  status EscrowMilestoneStatus @default(PENDING)

  // Evidence and notes
  evidence      String? // URL or description of completion evidence
  approvalNotes String? // Notes from buyer when approving

  // Approval tracking
  completedAt    DateTime?
  approvedAt     DateTime?
  approvedById   String?
  releasedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([escrowId])
  @@index([status])
}

model EscrowDispute {
  id String @id @default(uuid())

  escrowId String
  escrow   Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  // Dispute details
  raisedById String
  reason     String
  evidence   String? // URLs to evidence documents

  // Status
  status     String @default("OPEN") // OPEN, UNDER_REVIEW, RESOLVED, CLOSED
  resolution String?

  // Resolution
  resolvedAt   DateTime?
  resolvedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([escrowId])
  @@index([status])
}

// ============================================
// MESSAGING (In-App Communication)
// ============================================

// Conversation - can be linked to a negotiation or property, or standalone
model Conversation {
  id String @id @default(uuid())

  // Optional link to negotiation for contextual conversations
  negotiationId String?      @unique
  negotiation   Negotiation? @relation(fields: [negotiationId], references: [id], onDelete: SetNull)

  // Optional link to property for direct property inquiries
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  // Conversation metadata
  subject       String?
  lastMessageAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages     Message[]
  participants ConversationParticipant[]

  @@index([negotiationId])
  @@index([propertyId])
  @@index([lastMessageAt])
}

// Tracks participants in a conversation with read status
model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  lastReadAt  DateTime?
  unreadCount Int       @default(0)
  isArchived  Boolean   @default(false)
  isMuted     Boolean   @default(false)

  createdAt DateTime @default(now())

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

// Individual message in a conversation
model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  type    MessageType @default(TEXT)
  content String

  isEdited Boolean   @default(false)
  editedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================
// SERVICE PROVIDERS (PROD-060 to PROD-068)
// ============================================

// Service Provider Profile (PROD-060, PROD-061)
model ServiceProvider {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Service type (PROD-060.2)
  serviceType ServiceType

  // Application status (PROD-060.6)
  status ServiceProviderStatus @default(PENDING)

  // Profile details (PROD-061.3) - flexible JSON structure per service type
  // Example: { "yearsExperience": 5, "specializations": ["residential", "commercial"], "hourlyRate": 50 }
  serviceDetails Json?

  // Service area coverage (PROD-061.5)
  // Stored as JSON: { "city": "Budapest", "radius": 25, "country": "HU" }
  serviceArea Json?

  // Supporting documents (PROD-060.5)
  // Array of { "type": "license", "url": "...", "name": "..." }
  documents Json?

  // Profile completeness (PROD-061.4)
  profileCompleteness Int @default(0) // 0-100 percentage

  // Biography and qualifications
  bio            String?
  qualifications String?
  experience     String?

  // Verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Admin notes (for approval/rejection)
  adminNotes   String?
  reviewedAt   DateTime?
  reviewedById String?

  // Relations
  availability           ProviderAvailability[]
  availabilityExceptions AvailabilityException[]
  receivedRequests       ServiceRequest[]        @relation("ProviderRequests")
  reviews                ProviderReview[]
  maintenanceAssignments MaintenanceRequest[] // Maintenance assignments (PROD-103)

  // Aggregated rating (PROD-068.6)
  averageRating Float @default(0)
  totalReviews  Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, serviceType]) // One profile per service type per user (PROD-061.2)
  @@index([userId])
  @@index([serviceType])
  @@index([status])
  @@index([averageRating])
}

// Provider Weekly Availability (PROD-062.1, PROD-062.2)
model ProviderAvailability {
  id         String          @id @default(uuid())
  providerId String
  provider   ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  dayOfWeek   Int // 0-6 (Sunday-Saturday)
  startTime   String // "09:00" format
  endTime     String // "17:00" format
  isAvailable Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, dayOfWeek])
  @@index([providerId])
}

// Availability Exceptions (PROD-062.3) - specific dates unavailable
model AvailabilityException {
  id         String          @id @default(uuid())
  providerId String
  provider   ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  date        DateTime @db.Date
  isAvailable Boolean  @default(false) // false = unavailable, true = override to available
  reason      String?

  createdAt DateTime @default(now())

  @@unique([providerId, date])
  @@index([providerId])
  @@index([date])
}

// Service Request / Job Offer (PROD-063, PROD-064)
model ServiceRequest {
  id String @id @default(uuid())

  // Who is requesting the service
  requesterId String
  requester   User   @relation(fields: [requesterId], references: [id])

  // Which provider (can be null if broadcasting to matching providers)
  providerId String?
  provider   ServiceProvider? @relation("ProviderRequests", fields: [providerId], references: [id])

  // Service details
  serviceType ServiceType
  propertyId  String? // Optional link to property
  property    Property?   @relation(fields: [propertyId], references: [id])

  // Request details
  title             String
  description       String
  preferredDate     DateTime?
  preferredTimeSlot String? // "09:00-12:00"
  urgency           String? // "normal", "urgent", "flexible"

  // Location (can differ from property)
  address String?
  city    String?
  country String?

  // Budget
  budget   Decimal? @db.Decimal(10, 2)
  currency String   @default("EUR")

  // Status (PROD-064.4)
  status ServiceRequestStatus @default(PENDING)

  // Provider response
  respondedAt     DateTime?
  rejectionReason String?

  // Completion
  completedAt     DateTime?
  completionNotes String?

  // Payment link (if applicable)
  transactionId String?

  // Review reference
  review ProviderReview?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requesterId])
  @@index([providerId])
  @@index([serviceType])
  @@index([status])
  @@index([propertyId])
}

// Provider Reviews (PROD-068)
model ProviderReview {
  id String @id @default(uuid())

  providerId String
  provider   ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation(fields: [reviewerId], references: [id])

  // Must be linked to a completed service request (PROD-068.5)
  serviceRequestId String         @unique
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])

  // Rating (PROD-068.3)
  rating Int // 1-5 stars

  // Written review (PROD-068.4)
  title   String?
  comment String?

  // Helpful votes
  helpfulCount Int @default(0)

  // Visibility
  isPublic Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([reviewerId])
  @@index([rating])
}

// ============================================
// MAINTENANCE REQUESTS (PROD-103)
// ============================================

model MaintenanceRequest {
  id String @id @default(uuid())

  // Property being maintained
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Associated lease (tenant's lease)
  leaseId String
  lease   Lease  @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  // Tenant (requester)
  tenantId String
  tenant   User   @relation("TenantMaintenanceRequests", fields: [tenantId], references: [id])

  // Landlord (property owner)
  landlordId String
  landlord   User   @relation("LandlordMaintenanceRequests", fields: [landlordId], references: [id])

  // Assigned service provider (optional)
  assignedProviderId String?
  assignedProvider   ServiceProvider? @relation(fields: [assignedProviderId], references: [id])

  // Request details
  type           MaintenanceRequestType
  priority       MaintenancePriority    @default(NORMAL)
  title          String
  description    String
  attachmentUrls String[]               @default([])

  // Status & workflow
  status          MaintenanceRequestStatus @default(SUBMITTED)
  rejectionReason String?

  // Scheduling
  preferredDate     DateTime?
  scheduledDate     DateTime?
  scheduledTimeSlot String? // e.g., "09:00-12:00"

  // Completion
  completionNotes     String?
  completionPhotos    String[]  @default([])
  estimatedCost       Decimal?  @db.Decimal(10, 2)
  actualCost          Decimal?  @db.Decimal(10, 2)
  completedAt         DateTime?
  confirmedByTenant   Boolean   @default(false)
  confirmedByLandlord Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([leaseId])
  @@index([tenantId])
  @@index([landlordId])
  @@index([status])
  @@index([assignedProviderId])
}

// ============================================
// LEASE RENEWALS (PROD-105)
// ============================================

model LeaseRenewal {
  id String @id @default(uuid())

  // Relationships
  leaseId    String
  lease      Lease   @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  landlordId String
  landlord   User    @relation("LandlordLeaseRenewals", fields: [landlordId], references: [id])
  tenantId   String
  tenant     User    @relation("TenantLeaseRenewals", fields: [tenantId], references: [id])
  newLeaseId String? @unique
  newLease   Lease?  @relation("RenewalNewLease", fields: [newLeaseId], references: [id])

  // Renewal terms
  status             LeaseRenewalStatus @default(PENDING)
  proposedStartDate  DateTime? // New lease start date
  proposedEndDate    DateTime? // New lease end date
  proposedRentAmount Decimal?           @db.Decimal(12, 2)
  proposedTerms      String? // Additional terms/notes
  offerExpiresAt     DateTime? // Deadline for tenant response

  // Tracking
  reminderSentAt DateTime? // When 60-day reminder was sent
  offerSentAt    DateTime? // When offer was sent to tenant
  respondedAt    DateTime? // When tenant responded
  declineReason  String? // Optional reason if declined

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leaseId])
  @@index([landlordId])
  @@index([tenantId])
  @@index([status])
}

// ============================================
// LANDLORD EXPENSES (PROD-100.4)
// ============================================

model Expense {
  id String @id @default(uuid())

  // Owner (landlord)
  landlordId String
  landlord   User   @relation("LandlordExpenses", fields: [landlordId], references: [id])

  // Optional property association
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  // Expense details
  category    ExpenseCategory
  description String
  amount      Decimal         @db.Decimal(12, 2)
  currency    String          @default("EUR")

  // Date of expense
  expenseDate DateTime

  // Receipt/documentation
  receiptUrl String?
  notes      String?

  // Recurring expense tracking
  isRecurring     Boolean @default(false)
  recurringPeriod String? // "monthly", "quarterly", "annually"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([landlordId])
  @@index([propertyId])
  @@index([category])
  @@index([expenseDate])
}

// ============================================
// TENANT DOCUMENTS (PROD-106.7)
// ============================================

enum TenantDocumentType {
  LEASE_AGREEMENT // Original lease document
  SIGNED_LEASE // Signed version of lease
  PAYMENT_RECEIPT // Rent payment receipts
  MOVE_IN_CHECKLIST // Move-in inspection
  MOVE_OUT_CHECKLIST // Move-out inspection
  NOTICE // Notices (rent increase, etc.)
  OTHER // Miscellaneous documents
}

model TenantDocument {
  id String @id @default(uuid())

  // Associated lease
  leaseId String
  lease   Lease  @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  // Document details
  type        TenantDocumentType
  name        String // Display name
  description String?
  documentUrl String // External URL to document

  // File metadata
  fileSize Int? // Size in bytes
  mimeType String? // application/pdf, image/jpeg, etc.

  // Audit trail
  uploadedById String // User who uploaded the document

  createdAt DateTime @default(now())

  @@index([leaseId])
  @@index([type])
  @@index([uploadedById])
}

// ============================================
// AI TOUR GUIDE (PROD-120 to PROD-133)
// ============================================

// Voice style for narration (PROD-127)
enum VoiceStyle {
  HISTORICAL // Formal, informative tone
  FRIENDLY // Casual, conversational tone
  PROFESSIONAL // Business-like tone
}

// Interest categories for filtered content (PROD-133)
enum InterestCategory {
  HISTORY
  FOOD
  ARCHITECTURE
  NATURE
  SHOPPING
  NIGHTLIFE
  CULTURE
  SPORTS
  FAMILY
  ART
}

// POI types for comprehensive coverage (PROD-122)
enum PoiType {
  RESTAURANT
  BUILDING
  PARK
  SHOP
  LANDMARK
  MUSEUM
  HOTEL
  TRANSPORT
  ENTERTAINMENT
  HEALTHCARE
  EDUCATION
  OTHER
}

// User's tour preferences (PROD-123, PROD-127, PROD-133)
model TourPreferences {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Voice settings (PROD-127)
  voiceStyle VoiceStyle @default(FRIENDLY)
  language   String     @default("en") // ISO 639-1 code

  // Interest preferences (PROD-133)
  // Stored as JSON array of InterestCategory values
  interests Json @default("[]")

  // Follow Me mode preference (PROD-125)
  followMeEnabled Boolean @default(true)
  poiRadius       Int     @default(100) // meters (PROD-121.5)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Saved Places / Bookmarks (PROD-130)
model SavedPlace {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // POI identification (Google Places)
  placeId   String // Google Places ID
  placeName String // Cached name
  placeType PoiType @default(OTHER)

  // Location
  latitude  Float
  longitude Float
  address   String?

  // User-added data
  notes String? // User notes (PROD-130.1)

  createdAt DateTime @default(now())

  // One saved place per user per POI
  @@unique([userId, placeId])
  @@index([userId])
  @@index([placeId])
}

// Custom Tours (PROD-131)
model CustomTour {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String // Tour name (PROD-131.1)
  description String?

  // Sharing (PROD-131.7)
  isPublic Boolean @default(false)

  // Calculated values
  estimatedDuration Int? // Total minutes (PROD-131.5)
  totalDistance     Float? // Total meters

  // Tour stops
  stops TourStop[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isPublic])
}

// Tour Stops within a Custom Tour (PROD-131.2, PROD-131.3)
model TourStop {
  id String @id @default(uuid())

  tourId String
  tour   CustomTour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // POI identification
  placeId   String // Google Places ID
  placeName String // Cached name
  placeType PoiType @default(OTHER)

  // Location
  latitude  Float
  longitude Float
  address   String?

  // Ordering (PROD-131.3)
  orderIndex Int // 0-based order in tour

  // Timing
  arrivalDuration Int? // Minutes from previous stop
  stayDuration    Int  @default(15) // Minutes to spend here

  // Custom narration override (optional)
  customNarration String?

  createdAt DateTime @default(now())

  @@unique([tourId, orderIndex])
  @@index([tourId])
  @@index([placeId])
}

// User Notes on POIs (PROD-132)
model UserNote {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // POI identification
  placeId   String // Google Places ID
  placeName String? // Cached name for display

  // Note content (PROD-132.2)
  text String

  // Photo attachments (PROD-132.3)
  // JSON array: [{ url, caption }]
  photos Json @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([placeId])
  @@index([userId, placeId])
}

// ============================================
// PLATFORM SERVICES (PROD-080, PROD-081, PROD-082)
// ============================================

// Provider Status (PROD-081.5)
enum PlatformProviderStatus {
  PENDING // Application submitted, awaiting review
  APPROVED // Approved and active
  SUSPENDED // Temporarily suspended
  REJECTED // Application rejected
}

// Insurance Service Types (PROD-082.1)
enum InsuranceType {
  HOME // Homeowner's insurance
  RENTERS // Renter's insurance
  LANDLORD // Landlord/property insurance
  TITLE // Title insurance
  MORTGAGE // Mortgage insurance (PMI)
  LIABILITY // Liability coverage
  FLOOD // Flood insurance
  FIRE // Fire insurance
  OTHER
}

// Mortgage Product Types (PROD-082.2)
enum MortgageProductType {
  FIXED_30 // 30-year fixed rate
  FIXED_15 // 15-year fixed rate
  FIXED_20 // 20-year fixed rate
  FIXED_10 // 10-year fixed rate
  ARM_5_1 // 5/1 Adjustable rate
  ARM_7_1 // 7/1 Adjustable rate
  FHA // FHA loans
  VA // VA loans
  JUMBO // Jumbo loans
  USDA // USDA rural loans
  REFINANCE // Refinancing options
  HOME_EQUITY // Home equity loans/HELOC
  OTHER
}

// Inquiry Status (PROD-082.4)
enum InquiryStatus {
  PENDING // Sent, awaiting response
  VIEWED // Provider viewed the inquiry
  RESPONDED // Provider responded
  CLOSED // Inquiry closed/resolved
  EXPIRED // No response within timeframe
}

// ============================================
// NEIGHBORHOOD & LOCATION (PROD-150 to PROD-158)
// ============================================

// School Level (PROD-151)
enum SchoolLevel {
  ELEMENTARY
  MIDDLE
  HIGH
  PRIVATE
  CHARTER
}

// Amenity Category (PROD-150, PROD-158)
enum AmenityCategory {
  RESTAURANT
  GROCERY
  SHOPPING
  HEALTHCARE
  FITNESS
  PARK
  ENTERTAINMENT
  COFFEE
  BANK
  TRANSIT
  SCHOOL
  LIBRARY
  PHARMACY
  GAS_STATION
}

// Climate Risk Type (PROD-156)
enum ClimateRiskType {
  FLOOD
  FIRE
  EARTHQUAKE
  HURRICANE
  TORNADO
  DROUGHT
}

// Risk Level (PROD-156)
enum RiskLevel {
  MINIMAL
  LOW
  MODERATE
  HIGH
  EXTREME
}

// ============================================
// FINANCIAL TOOLS (PROD-160 to PROD-169)
// ============================================

// Property Type for Financial Calculations (PROD-164)
enum FinancialPropertyType {
  RESIDENTIAL_SINGLE
  RESIDENTIAL_MULTI
  COMMERCIAL
  INDUSTRIAL
  MIXED_USE
}

// Market Trend (PROD-161)
enum MarketTrend {
  UP
  DOWN
  STABLE
}

// Insurance Provider (PROD-081.1)
model InsuranceProvider {
  id String @id @default(uuid())

  // Linked user account
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Company Information (PROD-081.1)
  companyName     String
  companyLogo     String? // URL to logo
  licenseNumber   String
  licenseState    String // State where licensed
  licenseExpiry   DateTime?
  taxId           String? // EIN/Tax ID

  // Contact Information
  email        String
  phone        String
  website      String?
  address      String?
  city         String?
  state        String?
  postalCode   String?
  country      String @default("US")

  // Business Details (PROD-082.1)
  description   String? // Company description
  yearFounded   Int?
  employeeCount Int?

  // Services Offered (PROD-082.1)
  insuranceTypes InsuranceType[]

  // Coverage Areas
  coverageAreas String[] // List of states/regions served

  // Status (PROD-081.5)
  status       PlatformProviderStatus @default(PENDING)
  statusReason String? // Reason for rejection/suspension
  approvedAt   DateTime?
  approvedBy   String? // Admin user ID

  // Application Details
  applicationNotes String? // Notes from application
  documents        Json    @default("[]") // Array of {type, url, name}

  // Platform Branding (PROD-080.4)
  isPlatformPartner Boolean @default(false) // Featured as 12done partner

  // Rating (derived from inquiries/feedback)
  averageRating  Float @default(0)
  totalReviews   Int   @default(0)
  responseRate   Float @default(0) // % of inquiries responded to
  avgResponseTime Int?  // Average response time in hours

  // Inquiries
  inquiries ProviderInquiry[] @relation("InsuranceProviderInquiries")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([isPlatformPartner])
  @@index([averageRating])
}

// Mortgage Provider (PROD-081.2)
model MortgageProvider {
  id String @id @default(uuid())

  // Linked user account
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Company Information (PROD-081.2)
  companyName    String
  companyLogo    String? // URL to logo
  nmlsId         String // NMLS license number (required for mortgage)
  licenseNumber  String? // Additional state license
  licenseState   String? // State where licensed
  licenseExpiry  DateTime?
  taxId          String? // EIN/Tax ID

  // Contact Information
  email        String
  phone        String
  website      String?
  address      String?
  city         String?
  state        String?
  postalCode   String?
  country      String @default("US")

  // Business Details (PROD-082.2)
  description   String? // Company description
  yearFounded   Int?
  employeeCount Int?

  // Products Offered (PROD-082.2)
  productTypes MortgageProductType[]

  // Lending Criteria
  minLoanAmount Decimal? @db.Decimal(12, 2)
  maxLoanAmount Decimal? @db.Decimal(12, 2)
  minCreditScore Int?

  // Coverage Areas
  lendingAreas String[] // List of states where they can lend

  // Current Rates (updated periodically)
  rates Json @default("{}") // { productType: rate }

  // Status (PROD-081.5)
  status       PlatformProviderStatus @default(PENDING)
  statusReason String? // Reason for rejection/suspension
  approvedAt   DateTime?
  approvedBy   String? // Admin user ID

  // Application Details
  applicationNotes String? // Notes from application
  documents        Json    @default("[]") // Array of {type, url, name}

  // Platform Branding (PROD-080.4)
  isPlatformPartner Boolean @default(false) // Featured as 12done partner

  // Rating (derived from inquiries/feedback)
  averageRating   Float @default(0)
  totalReviews    Int   @default(0)
  responseRate    Float @default(0) // % of inquiries responded to
  avgResponseTime Int?  // Average response time in hours

  // Inquiries
  inquiries ProviderInquiry[] @relation("MortgageProviderInquiries")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([nmlsId])
  @@index([isPlatformPartner])
  @@index([averageRating])
}

// Provider Inquiries (PROD-082.3, PROD-082.4)
model ProviderInquiry {
  id String @id @default(uuid())

  // Inquirer (user making the request)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Provider (one of these will be set)
  insuranceProviderId String?
  insuranceProvider   InsuranceProvider? @relation("InsuranceProviderInquiries", fields: [insuranceProviderId], references: [id], onDelete: Cascade)

  mortgageProviderId String?
  mortgageProvider   MortgageProvider? @relation("MortgageProviderInquiries", fields: [mortgageProviderId], references: [id], onDelete: Cascade)

  // Inquiry Type
  providerType String // "insurance" or "mortgage"

  // Property Context (optional)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  // Inquiry Details (PROD-082.3)
  subject     String
  message     String
  phoneNumber String? // Optional callback number

  // For Insurance Inquiries
  insuranceType InsuranceType?

  // For Mortgage Inquiries
  mortgageType  MortgageProductType?
  loanAmount    Decimal? @db.Decimal(12, 2)
  downPayment   Decimal? @db.Decimal(12, 2)
  creditScore   Int?

  // Status Tracking (PROD-082.4)
  status      InquiryStatus @default(PENDING)
  viewedAt    DateTime?
  respondedAt DateTime?

  // Provider Response
  response    String?
  responseBy  String? // User ID of responder (for company with multiple users)

  // User Feedback
  rating      Int? // 1-5 stars
  feedback    String?
  feedbackAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([insuranceProviderId])
  @@index([mortgageProviderId])
  @@index([status])
  @@index([providerType])
}

// ============================================
// NEIGHBORHOOD & LOCATION DATA (PROD-150 to PROD-158)
// ============================================

// Neighborhood Data Cache (PROD-150)
model NeighborhoodData {
  id String @id @default(uuid())

  // Location identifier (can be cached by lat/lng grid or zip code)
  latitude  Float
  longitude Float
  zipCode   String?
  city      String?
  state     String?

  // AI-Generated Summary (PROD-150.4)
  aiDescription String?
  neighborhood  String? // Neighborhood name

  // Mobility Scores (PROD-153)
  walkScore    Int? // 0-100
  transitScore Int? // 0-100
  bikeScore    Int? // 0-100

  // Safety Data (PROD-152)
  safetyScore     Int? // 0-100 (calculated)
  crimeData       Json? // { violent: rate, property: rate, total: rate }
  crimeRating     String? // "LOW", "MODERATE", "HIGH"

  // Demographics (PROD-154)
  demographics Json? // { population, medianAge, medianIncome, familyComposition }

  // Environmental (PROD-155)
  noiseLevel   String? // "LOW", "MODERATE", "HIGH"
  airQuality   Int? // AQI index
  pollenLevel  String? // "LOW", "MODERATE", "HIGH"

  // Cache metadata
  dataSource String? // API source name
  fetchedAt  DateTime @default(now())
  expiresAt  DateTime // Cache expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([latitude, longitude])
  @@index([zipCode])
  @@index([expiresAt])
}

// School Data (PROD-151)
model SchoolData {
  id String @id @default(uuid())

  // Location reference
  latitude  Float
  longitude Float

  // School Information
  name         String
  level        SchoolLevel
  rating       Float? // 1-10 scale (from GreatSchools or similar)
  studentCount Int?
  address      String?

  // Distance from reference point
  distanceKm     Float?
  walkingMinutes Int?
  drivingMinutes Int?

  // Additional data
  publicPrivate   String? // "PUBLIC" or "PRIVATE"
  schoolDistrict  String?
  grades          String? // e.g., "K-5", "6-8", "9-12"

  // External IDs
  externalId   String? // ID from external API
  dataSource   String? // "greatschools", "nces", etc.

  // Cache metadata
  fetchedAt DateTime @default(now())
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([latitude, longitude])
  @@index([level])
  @@index([rating])
  @@index([expiresAt])
}

// Climate Risk Data (PROD-156)
model ClimateRiskData {
  id String @id @default(uuid())

  // Location
  latitude  Float
  longitude Float
  zipCode   String?

  // Risk Assessments
  floodRisk      RiskLevel @default(MINIMAL)
  floodZone      String? // FEMA flood zone (A, AE, X, etc.)
  fireRisk       RiskLevel @default(MINIMAL)
  earthquakeRisk RiskLevel @default(MINIMAL)
  hurricaneRisk  RiskLevel @default(MINIMAL)
  tornadoRisk    RiskLevel @default(MINIMAL)
  droughtRisk    RiskLevel @default(MINIMAL)

  // Composite Score
  overallRiskScore Int? // 0-100 (100 = highest risk)
  overallRiskLevel RiskLevel @default(MINIMAL)

  // Historical Events
  historicalEvents Json? // Array of { type, date, severity, description }

  // Insurance Implications (PROD-156.6)
  insuranceNotes String?
  floodInsuranceRequired Boolean @default(false)

  // Data Source
  dataSource String? // "FEMA", "USGS", etc.
  fetchedAt  DateTime @default(now())
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([latitude, longitude])
  @@index([zipCode])
  @@index([overallRiskLevel])
  @@index([expiresAt])
}

// Nearby Amenities (PROD-150.3, PROD-158)
model NearbyAmenity {
  id String @id @default(uuid())

  // Reference location
  refLatitude  Float
  refLongitude Float

  // Amenity Information
  category    AmenityCategory
  name        String
  address     String?
  latitude    Float
  longitude   Float

  // Distance & Time
  distanceMeters Float
  walkingMinutes Int?
  drivingMinutes Int?

  // Additional Info
  rating     Float? // Google rating
  priceLevel Int? // 1-4 ($-$$$$)
  placeId    String? // Google Places ID
  photoUrl   String?
  website    String?
  phone      String?

  // Hours
  isOpenNow Boolean?
  hours     Json? // Opening hours

  // Cache metadata
  fetchedAt DateTime @default(now())
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([refLatitude, refLongitude])
  @@index([category])
  @@index([expiresAt])
}

// Future Development Projects (PROD-157)
model FutureDevelopment {
  id String @id @default(uuid())

  // Location
  latitude  Float
  longitude Float
  city      String?
  zipCode   String?

  // Project Details
  projectName     String
  projectType     String // "RESIDENTIAL", "COMMERCIAL", "INFRASTRUCTURE", "TRANSIT"
  description     String?
  developer       String?

  // Timeline
  plannedStart    DateTime?
  expectedEnd     DateTime?
  status          String? // "PROPOSED", "APPROVED", "IN_PROGRESS", "COMPLETED"

  // Impact
  impactRadius    Float? // km
  estimatedUnits  Int? // For residential
  squareFootage   Int? // For commercial

  // External Data
  permitNumber    String?
  sourceUrl       String?
  dataSource      String?

  // Cache
  fetchedAt DateTime @default(now())
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([latitude, longitude])
  @@index([projectType])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// FINANCIAL TOOLS (PROD-160 to PROD-169)
// ============================================

// Property Valuation (PROD-160)
model PropertyValuation {
  id         String @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Valuation Results
  estimatedValue   Decimal @db.Decimal(14, 2)
  confidenceLow    Decimal @db.Decimal(14, 2)
  confidenceHigh   Decimal @db.Decimal(14, 2)
  confidenceLevel  Float   // 0-100 percentage

  // Inputs Used
  comparableSales  Json? // Array of { address, price, sqm, date }
  marketData       Json? // { trend, avgPricePerSqm, inventory }
  propertyDetails  Json? // { size, bedrooms, condition, features }

  // Valuation Metadata
  valuationMethod  String  @default("COMPARABLE") // COMPARABLE, INCOME, COST
  modelVersion     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([createdAt])
}

// Price History (PROD-161)
model PriceHistory {
  id         String @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Price Data
  price       Decimal   @db.Decimal(14, 2)
  pricePerSqm Decimal?  @db.Decimal(10, 2)
  eventType   String    // "LISTED", "REDUCED", "INCREASED", "SOLD", "RENTED"
  eventDate   DateTime

  // Market Context
  daysOnMarket Int?
  marketTrend  MarketTrend?

  createdAt DateTime @default(now())

  @@index([propertyId])
  @@index([eventDate])
}

// Investment Portfolio (PROD-165)
model InvestmentPortfolio {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Portfolio Metrics (cached, updated periodically)
  totalValue       Decimal? @db.Decimal(14, 2)
  totalEquity      Decimal? @db.Decimal(14, 2)
  totalIncome      Decimal? @db.Decimal(14, 2) // Annual rental income
  totalExpenses    Decimal? @db.Decimal(14, 2) // Annual expenses
  cashFlow         Decimal? @db.Decimal(14, 2) // Net cash flow
  overallRoi       Float?   // Percentage
  cashOnCash       Float?   // Percentage

  // Properties in portfolio
  properties PortfolioProperty[]

  lastCalculatedAt DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
}

// Portfolio Property Link (PROD-165.2)
model PortfolioProperty {
  id          String @id @default(uuid())
  portfolioId String
  portfolio   InvestmentPortfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Purchase Details
  purchasePrice    Decimal  @db.Decimal(14, 2)
  purchaseDate     DateTime
  closingCosts     Decimal? @db.Decimal(12, 2)
  renovationCosts  Decimal? @db.Decimal(12, 2)

  // Financing
  downPayment      Decimal? @db.Decimal(12, 2)
  loanAmount       Decimal? @db.Decimal(14, 2)
  interestRate     Float?
  loanTermYears    Int?
  monthlyPayment   Decimal? @db.Decimal(10, 2)

  // Income
  monthlyRent      Decimal? @db.Decimal(10, 2)
  occupancyRate    Float?   @default(95) // Percentage
  otherIncome      Decimal? @db.Decimal(10, 2) // Parking, laundry, etc.

  // Expenses
  propertyTax      Decimal? @db.Decimal(10, 2) // Annual
  insurance        Decimal? @db.Decimal(10, 2) // Annual
  maintenance      Decimal? @db.Decimal(10, 2) // Annual estimate
  utilities        Decimal? @db.Decimal(10, 2) // Annual if landlord pays
  hoaFees          Decimal? @db.Decimal(10, 2) // Annual
  managementFee    Float?   // Percentage of rent
  otherExpenses    Decimal? @db.Decimal(10, 2)

  // Current Value
  currentValue     Decimal? @db.Decimal(14, 2)
  valueDate        DateTime?

  // Depreciation (PROD-164)
  depreciationType      FinancialPropertyType?
  depreciationYears     Int?      @default(27) // 27.5 for residential, 39 for commercial
  depreciationStartDate DateTime?
  landValue             Decimal?  @db.Decimal(14, 2) // Land is not depreciated

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([portfolioId, propertyId])
  @@index([portfolioId])
  @@index([propertyId])
}

// Down Payment Assistance Programs (PROD-167)
model DownPaymentProgram {
  id String @id @default(uuid())

  // Program Info
  name            String
  description     String?
  programType     String // "GRANT", "LOAN", "DEFERRED_LOAN", "TAX_CREDIT"

  // Eligibility
  state           String? // US state or "FEDERAL"
  county          String?
  city            String?
  maxIncome       Decimal? @db.Decimal(12, 2) // Max household income
  maxPurchasePrice Decimal? @db.Decimal(14, 2)
  firstTimeBuyer  Boolean  @default(true)
  minCreditScore  Int?

  // Benefits
  maxAmount       Decimal? @db.Decimal(12, 2)
  percentageOfPrice Float? // Alternative to fixed amount

  // Application
  applicationUrl  String?
  contactInfo     String?
  deadline        DateTime?

  // Status
  isActive        Boolean @default(true)
  lastVerified    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([state])
  @@index([isActive])
}

// Tax Report (PROD-168)
model TaxReport {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Report Period
  taxYear   Int
  startDate DateTime
  endDate   DateTime

  // Income Summary
  rentalIncome     Decimal @db.Decimal(14, 2) @default(0)
  otherIncome      Decimal @db.Decimal(12, 2) @default(0)
  totalIncome      Decimal @db.Decimal(14, 2) @default(0)

  // Expense Summary
  mortgageInterest Decimal @db.Decimal(12, 2) @default(0)
  propertyTaxes    Decimal @db.Decimal(12, 2) @default(0)
  insurance        Decimal @db.Decimal(12, 2) @default(0)
  repairs          Decimal @db.Decimal(12, 2) @default(0)
  maintenance      Decimal @db.Decimal(12, 2) @default(0)
  utilities        Decimal @db.Decimal(12, 2) @default(0)
  management       Decimal @db.Decimal(12, 2) @default(0)
  professional     Decimal @db.Decimal(12, 2) @default(0) // Legal, accounting
  depreciation     Decimal @db.Decimal(12, 2) @default(0)
  otherExpenses    Decimal @db.Decimal(12, 2) @default(0)
  totalExpenses    Decimal @db.Decimal(14, 2) @default(0)

  // Net
  netIncome        Decimal @db.Decimal(14, 2) @default(0)

  // Property Breakdown
  propertyDetails  Json? // Array of per-property income/expenses

  // Report metadata
  status           String @default("DRAFT") // DRAFT, FINAL
  notes            String?
  exportedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, taxYear])
  @@index([userId])
  @@index([taxYear])
}

// Cash Flow Projection (PROD-169)
model CashFlowProjection {
  id         String @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Projection Settings
  projectionMonths Int @default(12)
  vacancyRate      Float @default(5) // Percentage
  rentGrowthRate   Float @default(2) // Annual percentage
  expenseGrowthRate Float @default(3) // Annual percentage

  // Monthly Projections
  projections Json // Array of { month, income, expenses, netCashFlow }

  // Summary
  totalProjectedIncome   Decimal @db.Decimal(14, 2)
  totalProjectedExpenses Decimal @db.Decimal(14, 2)
  totalProjectedCashFlow Decimal @db.Decimal(14, 2)
  averageMonthlyCashFlow Decimal @db.Decimal(12, 2)

  // Based on
  baseMonthlyRent    Decimal @db.Decimal(10, 2)
  baseMonthlyExpense Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
}

// ============================================
// PROFIT-SHARING & REVENUE DISTRIBUTION
// ============================================

// Revenue Share Type
enum RevenueShareType {
  PLATFORM_OWNER    // %A - Platform's share
  BUYER_REWARD      // %D - Reward for buyer
  DIRECT_INVITER    // %E - Direct inviter commission
  UPSTREAM_NETWORK  // %F - Upstream network shares (up to 10 levels)
  ALL_USERS_SHARE   // %C - Distributed to all active users
}

// Revenue Share Status
enum RevenueShareStatus {
  PENDING     // Calculated but not yet processed
  PROCESSED   // Added to user wallet
  PAID_OUT    // Withdrawn by user
  CANCELLED   // Transaction was refunded/cancelled
}

// Payout Request Status
enum PayoutStatus {
  PENDING     // Request submitted
  PROCESSING  // Being processed
  COMPLETED   // Payout sent
  FAILED      // Payout failed
  CANCELLED   // Cancelled by user or admin
}

// Platform Configuration (Singleton - only one active at a time)
model PlatformConfiguration {
  id String @id @default(uuid())

  // Percentage Configuration (must equal 100%)
  platformOwnerPercent    Float @default(30)  // %A - Platform Owner (30%)
  userNetworkTotalPercent Float @default(50)  // %B - User Network Total (50%)
  allUsersSharePercent    Float @default(20)  // %C - All Users Share (20%)

  // Network Breakdown (must equal userNetworkTotalPercent)
  buyerRewardPercent      Float @default(10)  // %D - Buyer Reward (10%)
  directInviterPercent    Float @default(20)  // %E - Direct Inviter (20%)
  upstreamNetworkPercent  Float @default(20)  // %F - Upstream Network (20%)

  // Upstream Network Configuration
  maxUpstreamLevels       Int   @default(10)  // Maximum levels for upstream distribution

  // How upstream network share is divided per level (decreasing)
  // Each level gets: upstreamNetworkPercent / sum(levelWeights) * levelWeight[level]
  upstreamLevelWeights    Json  @default("[10, 9, 8, 7, 6, 5, 4, 3, 2, 1]")

  // Minimum balance for payout request
  minPayoutAmount         Decimal @db.Decimal(10, 2) @default(50.00)

  // Active flag (only one config should be active)
  isActive Boolean @default(false)

  // Audit trail
  createdById String?
  updatedById String?
  activatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// User Wallet - Tracks user earnings and balance
model UserWallet {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Current balance (available for payout)
  balance         Decimal @db.Decimal(14, 2) @default(0)
  currency        String  @default("EUR")

  // Lifetime earnings breakdown
  totalEarnings           Decimal @db.Decimal(14, 2) @default(0)
  buyerRewardsEarned      Decimal @db.Decimal(14, 2) @default(0)
  inviterCommissionsEarned Decimal @db.Decimal(14, 2) @default(0)
  networkSharesEarned     Decimal @db.Decimal(14, 2) @default(0)
  allUsersShareEarned     Decimal @db.Decimal(14, 2) @default(0)

  // Payout history
  totalPaidOut    Decimal @db.Decimal(14, 2) @default(0)
  lastPayoutAt    DateTime?

  // Relations
  revenueShares   RevenueShare[]
  payoutRequests  PayoutRequest[]
  walletHistory   WalletTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([balance])
}

// Revenue Distribution - Tracks how a transaction's revenue was distributed
model RevenueDistribution {
  id String @id @default(uuid())

  // Link to the transaction that generated this revenue
  transactionId String @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // Total revenue amount (platform fee from the transaction)
  totalRevenue    Decimal @db.Decimal(14, 2)
  currency        String  @default("EUR")

  // Distribution amounts (calculated based on active config at time of transaction)
  platformAmount      Decimal @db.Decimal(14, 2)  // %A
  buyerRewardAmount   Decimal @db.Decimal(14, 2)  // %D
  directInviterAmount Decimal @db.Decimal(14, 2)  // %E
  upstreamNetworkAmount Decimal @db.Decimal(14, 2) // %F
  allUsersShareAmount Decimal @db.Decimal(14, 2)  // %C

  // Configuration snapshot (percentages at time of distribution)
  configSnapshot Json

  // Processing status
  status          RevenueShareStatus @default(PENDING)
  processedAt     DateTime?
  errorMessage    String?

  // Individual shares (one per recipient)
  shares RevenueShare[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Revenue Share - Individual share for a recipient
model RevenueShare {
  id String @id @default(uuid())

  // Link to distribution
  distributionId String
  distribution   RevenueDistribution @relation(fields: [distributionId], references: [id], onDelete: Cascade)

  // Recipient
  recipientId String
  wallet      UserWallet @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  // Share details
  shareType   RevenueShareType
  amount      Decimal @db.Decimal(14, 2)
  currency    String  @default("EUR")

  // For upstream network shares, which level (1 = direct inviter's inviter, etc.)
  upstreamLevel Int?

  // Status
  status      RevenueShareStatus @default(PENDING)
  processedAt DateTime?

  // Notes (e.g., "Level 3 upstream from buyer")
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([distributionId])
  @@index([recipientId])
  @@index([shareType])
  @@index([status])
}

// Wallet Transaction - Audit log for all wallet changes
model WalletTransaction {
  id String @id @default(uuid())

  walletId String
  wallet   UserWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Transaction type
  type        String  // "CREDIT", "DEBIT", "PAYOUT", "ADJUSTMENT"
  amount      Decimal @db.Decimal(14, 2)
  currency    String  @default("EUR")

  // Balance after this transaction
  balanceAfter Decimal @db.Decimal(14, 2)

  // Reference to source (revenue share, payout, etc.)
  referenceType String?  // "REVENUE_SHARE", "PAYOUT", "ADMIN_ADJUSTMENT"
  referenceId   String?

  // Description
  description String?

  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([type])
  @@index([createdAt])
}

// Payout Request - User requests to withdraw their balance
model PayoutRequest {
  id String @id @default(uuid())

  walletId String
  wallet   UserWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Amount requested
  amount   Decimal @db.Decimal(14, 2)
  currency String  @default("EUR")

  // Payout method
  payoutMethod String // "BANK_TRANSFER", "PAYPAL", "STRIPE"
  payoutDetails Json  // { iban, accountName } or { paypalEmail } etc.

  // Status
  status      PayoutStatus @default(PENDING)
  processedAt DateTime?
  processedBy String?

  // External reference (from payment provider)
  externalReference String?

  // Notes
  notes       String?
  failureReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([walletId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// STAY PLANNING (PROD-140 to PROD-144)
// ============================================

// Season preference
enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ANY
}

// Activity/Interest categories
enum InterestCategory {
  ADVENTURE
  BEACH
  CULTURE
  DINING
  FAMILY
  HIKING
  HISTORY
  MUSEUMS
  NATURE
  NIGHTLIFE
  RELAXATION
  SHOPPING
  SPORTS
  WINE_TASTING
}

// Trip Plan Status
enum TripPlanStatus {
  DRAFT
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

// Attraction Category
enum AttractionCategory {
  MUSEUM
  MONUMENT
  PARK
  RESTAURANT
  BAR
  BEACH
  HIKING_TRAIL
  VIEWPOINT
  SHOPPING_CENTER
  ENTERTAINMENT
  SPA
  SPORTS_FACILITY
  HISTORICAL_SITE
  RELIGIOUS_SITE
  NATURE_RESERVE
  THEME_PARK
  ZOO
  AQUARIUM
}

// Booking Status
enum AttractionBookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

// Catering Quote Status
enum CateringQuoteStatus {
  REQUESTED
  QUOTED
  ACCEPTED
  DECLINED
  EXPIRED
}

// Stay Planning Session (PROD-140) - Wizard state
model StayPlanningSession {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Wizard answers
  season           Season?
  startDate        DateTime?
  endDate          DateTime?
  budgetMin        Decimal?  @db.Decimal(10, 2)
  budgetMax        Decimal?  @db.Decimal(10, 2)
  currency         String    @default("EUR")
  interests        InterestCategory[]
  numberOfGuests   Int?
  hasChildren      Boolean?
  childrenAges     Int[]     @default([])
  mobilityNeeds    Boolean?  @default(false)
  preferredPace    String?   // "relaxed", "moderate", "packed"

  // AI-generated proposals
  proposals    Json?    // Array of suggested itineraries
  selectedProposalIndex Int?

  // Resulting trip plan (if completed)
  tripPlan     TripPlan?

  // Session status
  currentStep  Int      @default(1)
  isCompleted  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([propertyId])
  @@index([isCompleted])
}

// Trip Plan (PROD-141) - Daily schedules
model TripPlan {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  // Link to planning session
  planningSessionId String? @unique
  planningSession   StayPlanningSession? @relation(fields: [planningSessionId], references: [id])

  // Trip details
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  status      TripPlanStatus @default(DRAFT)

  // Budget tracking
  estimatedBudget Decimal? @db.Decimal(10, 2)
  actualSpent     Decimal? @db.Decimal(10, 2)
  currency        String   @default("EUR")

  // Days and activities
  days TripDay[]

  // Bookings linked to this plan
  attractionBookings AttractionBooking[]

  // Calendar export
  calendarExportedAt DateTime?
  icalUid            String?   @unique

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([propertyId])
  @@index([status])
  @@index([startDate])
}

// Trip Day - Individual day in a trip plan
model TripDay {
  id String @id @default(uuid())

  tripPlanId String
  tripPlan   TripPlan @relation(fields: [tripPlanId], references: [id], onDelete: Cascade)

  date       DateTime
  dayNumber  Int      // 1, 2, 3...
  theme      String?  // "Beach Day", "City Exploration"

  // Activities for this day
  activities TripActivity[]

  // Weather (if fetched)
  weatherForecast Json?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tripPlanId, dayNumber])
  @@index([tripPlanId])
  @@index([date])
}

// Trip Activity - Individual activity within a day
model TripActivity {
  id String @id @default(uuid())

  tripDayId String
  tripDay   TripDay @relation(fields: [tripDayId], references: [id], onDelete: Cascade)

  // Timing
  startTime DateTime
  endTime   DateTime
  order     Int      // Order within the day

  // Activity details
  title       String
  description String?
  category    InterestCategory?
  location    String?
  address     String?
  latitude    Float?
  longitude   Float?

  // Travel from previous activity
  travelTimeMinutes Int?
  travelMode        String? // "walking", "driving", "public_transit"
  travelDistance    Float?  // in km

  // Linked attraction (if applicable)
  attractionId String?
  attraction   Attraction? @relation(fields: [attractionId], references: [id])

  // Booking (if applicable)
  bookingId String?       @unique
  booking   AttractionBooking? @relation(fields: [bookingId], references: [id])

  // Cost estimate
  estimatedCost Decimal? @db.Decimal(10, 2)
  currency      String   @default("EUR")

  // Meal type (for restaurant activities)
  mealType String? // "breakfast", "lunch", "dinner", "snack"

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tripDayId])
  @@index([attractionId])
  @@index([startTime])
}

// Attraction (PROD-142) - Touristic information
model Attraction {
  id String @id @default(uuid())

  // Basic info
  name        String
  description String?
  category    AttractionCategory
  subcategory String?

  // Location
  address   String
  city      String
  country   String
  latitude  Float
  longitude Float

  // External IDs
  googlePlaceId    String? @unique
  tripAdvisorId    String? @unique
  yelpId           String?

  // Ratings
  rating           Float?  // 0-5
  reviewCount      Int?
  tripAdvisorRating Float?
  googleRating     Float?

  // Details
  imageUrl         String?
  imageUrls        String[]
  website          String?
  phone            String?
  priceLevel       Int?    // 1-4 ($ to $$$$)
  estimatedDuration Int?   // in minutes

  // Opening hours (JSON format)
  openingHours Json?

  // Features/Tags
  features String[]

  // Activities using this attraction
  activities TripActivity[]

  // Bookings for this attraction
  bookings AttractionBooking[]

  // Cache control
  lastSyncedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, country])
  @@index([category])
  @@index([rating])
  @@index([latitude, longitude])
}

// Attraction Booking (PROD-143)
model AttractionBooking {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  attractionId String
  attraction   Attraction @relation(fields: [attractionId], references: [id])

  tripPlanId String?
  tripPlan   TripPlan? @relation(fields: [tripPlanId], references: [id])

  // Linked activity (if part of trip plan)
  activity TripActivity?

  // Booking details
  bookingDate     DateTime
  bookingTime     DateTime?
  numberOfGuests  Int
  ticketType      String?   // "adult", "child", "senior", "family"

  // External booking
  provider          String?  // "getyourguide", "viator", "direct"
  externalBookingId String?
  externalUrl       String?

  // Pricing
  totalPrice   Decimal @db.Decimal(10, 2)
  currency     String  @default("EUR")
  pricePaid    Decimal? @db.Decimal(10, 2)

  // Status
  status       AttractionBookingStatus @default(PENDING)
  confirmedAt  DateTime?
  cancelledAt  DateTime?

  // Confirmation details
  confirmationCode String?
  ticketUrl        String?
  qrCode           String?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([attractionId])
  @@index([tripPlanId])
  @@index([status])
  @@index([bookingDate])
}

// Catering Provider (PROD-144)
model CateringProvider {
  id String @id @default(uuid())

  // Basic info
  name        String
  description String?
  logoUrl     String?

  // Contact
  email    String
  phone    String?
  website  String?

  // Location
  address  String
  city     String
  country  String
  serviceRadius Int? // in km

  // Business details
  cuisineTypes    String[]  // "Italian", "Mediterranean", "BBQ"
  eventTypes      String[]  // "Wedding", "Corporate", "Birthday"
  minGuests       Int?
  maxGuests       Int?
  pricePerPerson  Decimal?  @db.Decimal(8, 2)
  currency        String    @default("EUR")

  // Rating
  rating       Float?
  reviewCount  Int?

  // Menus
  menus CateringMenu[]

  // Quotes
  quotes CateringQuote[]

  // Verification
  isVerified   Boolean @default(false)
  verifiedAt   DateTime?

  // Status
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, country])
  @@index([isActive])
  @@index([rating])
}

// Catering Menu
model CateringMenu {
  id String @id @default(uuid())

  providerId String
  provider   CateringProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  name        String
  description String?
  menuType    String  // "Buffet", "Plated", "Cocktail", "Family-style"

  // Items
  items Json // Array of { name, description, dietaryInfo }

  // Pricing
  pricePerPerson Decimal @db.Decimal(8, 2)
  minimumGuests  Int?
  currency       String  @default("EUR")

  // Dietary options
  vegetarianOptions Boolean @default(false)
  veganOptions      Boolean @default(false)
  glutenFreeOptions Boolean @default(false)
  halalOptions      Boolean @default(false)
  kosherOptions     Boolean @default(false)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([isActive])
}

// Catering Quote Request (PROD-144)
model CateringQuote {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  providerId String
  provider   CateringProvider @relation(fields: [providerId], references: [id])

  // Event details
  eventDate     DateTime
  eventType     String
  numberOfGuests Int
  venue         String?
  venueAddress  String?

  // Property link (if event at listed property)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  // Requirements
  cuisinePreferences String[]
  dietaryRequirements String[]
  budgetMin          Decimal? @db.Decimal(10, 2)
  budgetMax          Decimal? @db.Decimal(10, 2)
  currency           String   @default("EUR")
  additionalNotes    String?

  // Quote response
  status         CateringQuoteStatus @default(REQUESTED)
  quotedAmount   Decimal?            @db.Decimal(10, 2)
  quotedDetails  String?
  quotedMenuId   String?
  quotedAt       DateTime?
  expiresAt      DateTime?

  // Response
  respondedAt    DateTime?
  responseNotes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([providerId])
  @@index([propertyId])
  @@index([status])
  @@index([eventDate])
}
