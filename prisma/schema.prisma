// 12done.com Database Schema
// Comprehensive Real Estate & Services Platform
// Phase 1: User Management, Properties, Search

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  AGENT  // Real estate agent (PROD-026)
  ADMIN
}

enum UserStatus {
  PENDING_VERIFICATION // Email not verified yet
  PENDING_PROFILE      // Email verified, profile incomplete
  ACTIVE               // Fully registered
  SUSPENDED
  DELETED
}

enum VerificationStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ListingType {
  FOR_SALE
  SHORT_TERM_RENT
  LONG_TERM_RENT
  EVENTS
  BARTER
}

enum PropertyStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD
  RENTED
  EXPIRED
  DELETED
}

enum EnergyEfficiencyRating {
  A_PLUS_PLUS
  A_PLUS
  A
  B
  C
  D
  E
  F
  G
  NOT_RATED
}

enum NotificationType {
  EMAIL_VERIFICATION
  WELCOME
  PASSWORD_RESET
  SEARCH_AGENT_MATCH
  INVITATION_SENT
  INVITATION_ACCEPTED
  PROPERTY_INQUIRY
  INSPECTION_BOOKED
  INSPECTION_REMINDER
  NEGOTIATION_STARTED
  OFFER_RECEIVED
  OFFER_ACCEPTED
  OFFER_REJECTED
  OFFER_COUNTERED
  PAYMENT_RECEIVED
  PAYMENT_CONFIRMED
  PAYMENT_FAILED
  REFUND_PROCESSED
  REFUND_CONFIRMED
  // Rental Applications (PROD-101)
  APPLICATION_RECEIVED
  APPLICATION_STATUS_CHANGED
  APPLICATION_WITHDRAWN
  // Rent Reminders (PROD-102)
  RENT_REMINDER_TENANT
  RENT_PAYMENT_RECEIVED
  RENT_OVERDUE_TENANT
  RENT_OVERDUE_LANDLORD
  // Maintenance Requests (PROD-103)
  MAINTENANCE_REQUEST_SUBMITTED
  MAINTENANCE_REQUEST_APPROVED
  MAINTENANCE_REQUEST_REJECTED
  MAINTENANCE_REQUEST_ASSIGNED
  MAINTENANCE_REQUEST_SCHEDULED
  MAINTENANCE_REQUEST_COMPLETED
  MAINTENANCE_REQUEST_CONFIRMED
  // Lease Renewals (PROD-105)
  LEASE_RENEWAL_REMINDER_LANDLORD
  LEASE_RENEWAL_OFFER_TENANT
  LEASE_RENEWAL_ACCEPTED
  LEASE_RENEWAL_DECLINED
  LEASE_RENEWAL_EXPIRED
}

// ============================================
// NEGOTIATIONS & TRANSACTIONS (PROD-090 to PROD-095)
// ============================================

enum NegotiationType {
  BUY       // Purchasing property
  RENT      // Renting property (short or long term)
}

enum NegotiationStatus {
  ACTIVE      // Negotiation is ongoing
  ACCEPTED    // Final offer accepted
  REJECTED    // Negotiation rejected/cancelled
  COMPLETED   // Transaction completed
  EXPIRED     // Negotiation timed out
}

enum OfferStatus {
  PENDING     // Awaiting response
  ACCEPTED    // Offer accepted
  REJECTED    // Offer rejected
  COUNTERED   // Counter-offer made
  EXPIRED     // Offer expired
  WITHDRAWN   // Offer withdrawn by maker
}

enum TransactionStatus {
  PENDING         // Payment not yet initiated
  PROCESSING      // Payment in progress
  COMPLETED       // Payment successful
  FAILED          // Payment failed
  REFUNDED        // Payment refunded
  CANCELLED       // Transaction cancelled
}

// ============================================
// MESSAGING (In-App Communication)
// ============================================

enum MessageType {
  TEXT    // Regular user message
  SYSTEM  // System-generated message (e.g., "Offer accepted")
}

// ============================================
// SERVICE PROVIDERS (PROD-060 to PROD-068)
// ============================================

enum ServiceType {
  LAWYER
  CLEANER
  HANDYMAN
  PROPERTY_SHOWING
  RECEPTIONIST
}

enum ServiceProviderStatus {
  PENDING     // Application submitted, awaiting review
  APPROVED    // Approved by admin
  REJECTED    // Rejected by admin
  SUSPENDED   // Temporarily suspended
  INACTIVE    // Provider chose to deactivate
}

enum ServiceRequestStatus {
  PENDING       // Request sent, awaiting provider response
  ACCEPTED      // Provider accepted the job
  REJECTED      // Provider declined
  IN_PROGRESS   // Job is being performed
  COMPLETED     // Job completed
  CANCELLED     // Request cancelled
}

// ============================================
// RENTAL APPLICATIONS (PROD-101)
// ============================================

enum ApplicationStatus {
  PENDING       // Application submitted, awaiting review
  UNDER_REVIEW  // Owner is reviewing the application
  APPROVED      // Application approved
  REJECTED      // Application rejected
  WITHDRAWN     // Applicant withdrew the application
}

// ============================================
// LEASES & RENT PAYMENTS (PROD-102)
// ============================================

enum LeaseStatus {
  DRAFT         // Lease created but not yet active
  ACTIVE        // Currently active lease
  EXPIRED       // Lease has ended naturally
  TERMINATED    // Lease was terminated early
}

enum RentPaymentStatus {
  PENDING       // Payment is expected
  PAID          // Payment received
  OVERDUE       // Payment is past due date
  WAIVED        // Payment was waived by landlord
}

// ============================================
// LEASE RENEWALS (PROD-105)
// ============================================

enum LeaseRenewalStatus {
  PENDING       // 60-day window opened, awaiting landlord action
  OFFERED       // Landlord created offer, awaiting tenant response
  ACCEPTED      // Tenant accepted, new lease generated
  DECLINED      // Tenant declined the offer
  EXPIRED       // Offer expired without response
  CANCELLED     // Landlord cancelled the offer
}

// ============================================
// MAINTENANCE REQUESTS (PROD-103)
// ============================================

enum MaintenanceRequestType {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  CLEANING
  LANDSCAPING
  OTHER
}

enum MaintenanceRequestStatus {
  SUBMITTED      // Tenant submitted, awaiting landlord review
  APPROVED       // Landlord approved, ready for assignment
  REJECTED       // Landlord rejected with reason
  ASSIGNED       // Provider assigned, awaiting scheduling
  SCHEDULED      // Date/time confirmed
  IN_PROGRESS    // Work started
  COMPLETED      // Work finished, awaiting confirmation
  CONFIRMED      // Both parties confirmed completion
  CANCELLED      // Request cancelled
}

enum MaintenancePriority {
  LOW
  NORMAL
  URGENT
  EMERGENCY
}

// ============================================
// USER MANAGEMENT (PROD-001 to PROD-011)
// ============================================

model User {
  id                    String              @id @default(uuid())
  email                 String              @unique
  passwordHash          String
  firstName             String
  lastName              String
  phone                 String?             // International format (PROD-002)
  address               String?             // (PROD-002)
  postalCode            String?             // (PROD-002)
  city                  String?             // (PROD-002)
  country               String?             // ISO 3166-1 alpha-2 (PROD-002)
  role                  UserRole            @default(USER) // (PROD-004)
  status                UserStatus          @default(PENDING_VERIFICATION)

  // Email verification (PROD-001)
  emailVerified         Boolean             @default(false)
  emailVerifiedAt       DateTime?

  // ID Verification (PROD-008, PROD-010)
  idVerificationStatus  VerificationStatus  @default(NOT_STARTED)
  idVerifiedAt          DateTime?

  // Background Check (PROD-009)
  backgroundCheckStatus VerificationStatus  @default(NOT_STARTED)
  backgroundCheckAt     DateTime?

  // Social Media Profiles (PROD-005)
  socialProfiles        SocialProfile[]

  // Invitation System (PROD-006, PROD-007)
  invitedById           String?
  invitedBy             User?               @relation("InvitedBy", fields: [invitedById], references: [id])
  invitees              User[]              @relation("InvitedBy")
  sentInvitations       Invitation[]        @relation("SentInvitations")
  receivedInvitation    Invitation?         @relation("ReceivedInvitation")

  // Properties (PROD-020+)
  properties            Property[]

  // Search & Favorites (PROD-040+)
  searchAgents          SearchAgent[]
  favoriteProperties    FavoriteProperty[]
  browsingHistory       BrowsingHistory[]

  // Notifications (USER-020+)
  notifications         Notification[]

  // Auth Tokens
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  refreshTokens           RefreshToken[]

  // Inspection bookings
  bookedInspections     InspectionSlot[]

  // Negotiations & Transactions (PROD-090+)
  buyerNegotiations     Negotiation[]       @relation("BuyerNegotiations")
  sellerNegotiations    Negotiation[]       @relation("SellerNegotiations")
  madeOffers            Offer[]
  transactions          Transaction[]

  // Messaging
  conversationParticipants ConversationParticipant[]
  messagesSent             Message[]

  // Service Providers (PROD-060+)
  serviceProviderProfiles  ServiceProvider[]
  serviceRequests          ServiceRequest[]
  providerReviews          ProviderReview[]

  // Rental Applications (PROD-101)
  rentalApplications       RentalApplication[]

  // Leases (PROD-102)
  tenantLeases             Lease[]             @relation("TenantLeases")
  landlordLeases           Lease[]             @relation("LandlordLeases")

  // Maintenance Requests (PROD-103)
  tenantMaintenanceRequests   MaintenanceRequest[] @relation("TenantMaintenanceRequests")
  landlordMaintenanceRequests MaintenanceRequest[] @relation("LandlordMaintenanceRequests")

  // Lease Renewals (PROD-105)
  landlordLeaseRenewals       LeaseRenewal[]       @relation("LandlordLeaseRenewals")
  tenantLeaseRenewals         LeaseRenewal[]       @relation("TenantLeaseRenewals")

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([email])
  @@index([invitedById])
  @@index([status])
  @@index([role])
}

// Social Media Profiles (PROD-005)
model SocialProfile {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform   String   // facebook, instagram, linkedin, twitter, etc.
  profileUrl String
  createdAt  DateTime @default(now())

  @@unique([userId, platform])
  @@index([userId])
}

// Email Verification Token (PROD-001)
model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

// Password Reset Token
model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

// JWT Refresh Token
model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

// ============================================
// INVITATION SYSTEM (PROD-006, PROD-007)
// ============================================

model Invitation {
  id               String           @id @default(uuid())
  email            String
  inviterId        String
  inviter          User             @relation("SentInvitations", fields: [inviterId], references: [id])
  status           InvitationStatus @default(PENDING)
  token            String           @unique

  // Track if invitation converted to user
  acceptedUserId   String?          @unique
  acceptedUser     User?            @relation("ReceivedInvitation", fields: [acceptedUserId], references: [id])

  // Kick-back eligibility tracking (PROD-006)
  kickbackEligible Boolean          @default(true)

  expiresAt        DateTime
  acceptedAt       DateTime?
  createdAt        DateTime         @default(now())

  @@index([email])
  @@index([token])
  @@index([inviterId])
  @@index([status])
}

// ============================================
// PROPERTY LISTINGS (PROD-020 to PROD-031)
// ============================================

model Property {
  id                     String                 @id @default(uuid())
  ownerId                String
  owner                  User                   @relation(fields: [ownerId], references: [id])

  // Location (PROD-020)
  address                String
  postalCode             String
  city                   String
  country                String                 // ISO 3166-1 alpha-2
  latitude               Float?
  longitude              Float?

  // Basic Info (PROD-021)
  title                  String
  description            String?
  aiGeneratedDescription String?                // (PROD-029)
  descriptionTone        String?                // luxury, family-friendly, investment-focused

  // Listing Types (PROD-022) - Multi-choice stored as array
  listingTypes           ListingType[]

  // Pricing (PROD-021, PROD-023)
  basePrice              Decimal                @db.Decimal(12, 2)
  currency               String                 @default("EUR")
  priceNegotiable        Boolean                @default(false)
  negotiabilityRange     Decimal?               @db.Decimal(5, 2) // Percentage, e.g., 10.00 = 10%
  dynamicPricingEnabled  Boolean                @default(false)

  // Dimensions & Characteristics (PROD-021, PROD-027)
  squareMeters           Float?
  lotSize                Float?                 // (PROD-042)
  bedrooms               Int?
  bathrooms              Int?
  floors                 Int?
  yearBuilt              Int?                   // (PROD-042)

  // Property Details (PROD-027)
  energyEfficiency       EnergyEfficiencyRating @default(NOT_RATED)
  energyCertificateUrl   String?
  hoaFees                Decimal?               @db.Decimal(10, 2)
  hoaInfo                String?
  propertyTaxHistory     Json?                  // Array of {year, amount}
  utilitiesCostHistory   Json?                  // Array of {month, electricity, gas, water}

  // Features (PROD-042)
  petFriendly            Boolean                @default(false)
  newlyBuilt             Boolean                @default(false)
  accessible             Boolean                @default(false)

  // No Agents Tag (PROD-026)
  noAgents               Boolean                @default(false)

  // Status
  status                 PropertyStatus         @default(DRAFT)
  publishedAt            DateTime?

  // Relations
  media                  PropertyMedia[]
  floorPlans             FloorPlan[]
  availabilitySlots      AvailabilitySlot[]
  inspectionSlots        InspectionSlot[]
  openHouseEvents        OpenHouseEvent[]     // (PROD-048)
  dynamicPricingRules    DynamicPricingRule[]
  favoritedBy            FavoriteProperty[]
  browsingHistory        BrowsingHistory[]
  negotiations           Negotiation[]        // (PROD-090)
  conversations          Conversation[]       // Direct property inquiries
  serviceRequests        ServiceRequest[]     // Service requests for this property
  rentalApplications     RentalApplication[]  // Rental applications (PROD-101)
  leases                 Lease[]              // Leases (PROD-102)
  maintenanceRequests    MaintenanceRequest[] // Maintenance requests (PROD-103)

  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt

  @@index([ownerId])
  @@index([city])
  @@index([country])
  @@index([status])
  @@index([listingTypes])
  @@index([basePrice])
  @@index([latitude, longitude])
}

// Property Media (PROD-028)
model PropertyMedia {
  id           String   @id @default(uuid())
  propertyId   String
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  type         String   // photo, video, tour_360, tour_3d
  url          String
  thumbnailUrl String?
  caption      String?
  sortOrder    Int      @default(0)
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([propertyId])
  @@index([type])
}

// Floor Plans (PROD-027)
model FloorPlan {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  name       String   // "Ground Floor", "First Floor", etc.
  imageUrl   String
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  @@index([propertyId])
}

// Availability Calendar (PROD-024)
model AvailabilitySlot {
  id            String   @id @default(uuid())
  propertyId    String
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  startDate     DateTime
  endDate       DateTime
  isAvailable   Boolean  @default(true)
  pricePerNight Decimal? @db.Decimal(10, 2) // For short-term rentals
  notes         String?
  createdAt     DateTime @default(now())

  @@index([propertyId])
  @@index([startDate, endDate])
  @@index([isAvailable])
}

// Inspection Scheduling (PROD-025)
model InspectionSlot {
  id         String    @id @default(uuid())
  propertyId String
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  date       DateTime
  startTime  String    // "09:00"
  endTime    String    // "09:30"
  isBooked   Boolean   @default(false)
  bookedById String?
  bookedBy   User?     @relation(fields: [bookedById], references: [id])
  bookedAt   DateTime?
  createdAt  DateTime  @default(now())

  @@index([propertyId])
  @@index([date])
  @@index([isBooked])
}

// Open House Events (PROD-048)
model OpenHouseEvent {
  id          String   @id @default(uuid())
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  date        DateTime // The date of the open house
  startTime   String   // "10:00"
  endTime     String   // "14:00"
  description String?  // Optional details like "Refreshments provided"
  isPublic    Boolean  @default(true) // Whether visible to all users
  maxAttendees Int?    // Optional capacity limit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([propertyId])
  @@index([date])
}

// Dynamic Pricing Rules (PROD-023)
model DynamicPricingRule {
  id              String    @id @default(uuid())
  propertyId      String
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  name            String    // "Summer Season", "Holiday Premium", "Weekend Rate"
  startDate       DateTime?
  endDate         DateTime?
  dayOfWeek       Int?      // 0-6 (Sunday-Saturday) for recurring weekly rules
  priceMultiplier Decimal   @db.Decimal(4, 2) // 1.20 = 20% increase, 0.80 = 20% discount
  isActive        Boolean   @default(true)
  priority        Int       @default(0) // Higher priority rules applied first
  createdAt       DateTime  @default(now())

  @@index([propertyId])
  @@index([isActive])
}

// ============================================
// SEARCH & DISCOVERY (PROD-040 to PROD-050)
// ============================================

// Search Agent (PROD-040, PROD-041)
model SearchAgent {
  id                  String    @id @default(uuid())
  userId              String
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                String

  // Search Criteria (PROD-040, PROD-042) - Flexible JSON structure
  // Example: { listingTypes: ["FOR_SALE"], country: "HU", minPrice: 100000, maxPrice: 500000, ... }
  criteria            Json

  // Notifications (PROD-041)
  emailNotifications  Boolean   @default(true)
  inAppNotifications  Boolean   @default(true)

  isActive            Boolean   @default(true)
  lastTriggeredAt     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([userId])
  @@index([isActive])
}

// Favorite Properties (PROD-049)
model FavoriteProperty {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

// Browsing History for AI Recommendations (PROD-050)
model BrowsingHistory {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  viewedAt   DateTime @default(now())
  duration   Int?     // Seconds spent viewing

  @@index([userId])
  @@index([propertyId])
  @@index([viewedAt])
}

// ============================================
// RENTAL APPLICATIONS (PROD-101)
// ============================================

// Rental Application (PROD-101.2 to PROD-101.6)
model RentalApplication {
  id                  String            @id @default(uuid())

  // Applicant (user applying for the property)
  applicantId         String
  applicant           User              @relation(fields: [applicantId], references: [id])

  // Property being applied for
  propertyId          String
  property            Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Application status (PROD-101.5)
  status              ApplicationStatus @default(PENDING)

  // Employment Information (PROD-101.6)
  employmentStatus    String?           // "employed", "self-employed", "unemployed", "retired", "student"
  employer            String?
  jobTitle            String?
  monthlyIncome       Decimal?          @db.Decimal(12, 2)
  incomeCurrency      String            @default("EUR")
  employmentDuration  String?           // e.g., "2 years", "6 months"

  // References (PROD-101.6)
  // JSON array: [{ name, relationship, phone, email }]
  references          Json?

  // Rental Details
  desiredMoveInDate   DateTime?
  desiredLeaseTerm    Int?              // Months
  numberOfOccupants   Int?
  hasPets             Boolean           @default(false)
  petDetails          String?
  additionalNotes     String?

  // Supporting Documents
  // JSON array: [{ type, url, name }] - e.g., pay stubs, ID, etc.
  documents           Json?

  // Owner Response
  ownerNotes          String?
  reviewedAt          DateTime?

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // One application per user per property
  @@unique([applicantId, propertyId])
  @@index([applicantId])
  @@index([propertyId])
  @@index([status])
}

// ============================================
// LEASES (PROD-102)
// ============================================

// Lease Agreement (PROD-102.1)
model Lease {
  id                  String            @id @default(uuid())

  // Property being leased
  propertyId          String
  property            Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Tenant (renter)
  tenantId            String
  tenant              User              @relation("TenantLeases", fields: [tenantId], references: [id])

  // Landlord (property owner)
  landlordId          String
  landlord            User              @relation("LandlordLeases", fields: [landlordId], references: [id])

  // Lease terms
  startDate           DateTime
  endDate             DateTime
  rentAmount          Decimal           @db.Decimal(12, 2)
  currency            String            @default("EUR")
  dueDay              Int               // 1-28 day of month when rent is due

  // Security deposit
  securityDeposit     Decimal?          @db.Decimal(12, 2)
  securityDepositPaid Boolean           @default(false)

  // Status
  status              LeaseStatus       @default(DRAFT)

  // Optional document
  documentUrl         String?

  // Relations
  rentPayments        RentPayment[]
  maintenanceRequests MaintenanceRequest[] // Maintenance requests (PROD-103)
  renewals            LeaseRenewal[]       // Lease renewals (PROD-105)
  renewedFromRenewal  LeaseRenewal?        @relation("RenewalNewLease") // Renewal that created this lease

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([propertyId])
  @@index([tenantId])
  @@index([landlordId])
  @@index([status])
}

// Rent Payment Tracking (PROD-102.2 to PROD-102.6)
model RentPayment {
  id                  String            @id @default(uuid())

  // Associated lease
  leaseId             String
  lease               Lease             @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  // Payment details
  dueDate             DateTime
  amount              Decimal           @db.Decimal(12, 2)
  currency            String            @default("EUR")

  // Status
  status              RentPaymentStatus @default(PENDING)

  // Payment info (when paid)
  paidAt              DateTime?
  paidAmount          Decimal?          @db.Decimal(12, 2)
  paymentMethod       String?           // "bank_transfer", "cash", "card", etc.
  transactionRef      String?           // External reference number

  // Notification tracking
  reminderSentAt      DateTime?         // When 5-day reminder was sent
  overdueSentAt       DateTime?         // When overdue notification was sent

  // Notes
  notes               String?

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([leaseId, dueDate])          // One payment per due date per lease
  @@index([leaseId])
  @@index([dueDate])
  @@index([status])
}

// ============================================
// NOTIFICATIONS (USER-020 to USER-023)
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional context (propertyId, invitationId, etc.)
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// LOCALIZATION (USER-030 to USER-034, USER-040)
// ============================================

model Country {
  code        String  @id // ISO 3166-1 alpha-2
  name        String
  nativeName  String? // Name in local language
  phonePrefix String  // "+1", "+44", "+36", etc.
  currency    String  // ISO 4217 currency code
  isActive    Boolean @default(true)

  @@index([isActive])
}

// ============================================
// NEGOTIATIONS & TRANSACTIONS (PROD-090 to PROD-095)
// ============================================

// Negotiation (PROD-090)
model Negotiation {
  id           String            @id @default(uuid())
  propertyId   String
  property     Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Parties
  buyerId      String            // The interested party (buyer/renter)
  buyer        User              @relation("BuyerNegotiations", fields: [buyerId], references: [id])
  sellerId     String            // The property owner
  seller       User              @relation("SellerNegotiations", fields: [sellerId], references: [id])

  // Negotiation details
  type         NegotiationType   // BUY or RENT
  status       NegotiationStatus @default(ACTIVE)

  // For rentals
  startDate    DateTime?         // Rental start date
  endDate      DateTime?         // Rental end date

  // Message/notes
  initialMessage String?         // Initial message from buyer

  // Relations
  offers       Offer[]
  transaction  Transaction?
  conversation Conversation?

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([propertyId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([type])
}

// Offer (PROD-090)
model Offer {
  id            String      @id @default(uuid())
  negotiationId String
  negotiation   Negotiation @relation(fields: [negotiationId], references: [id], onDelete: Cascade)

  // Who made this offer
  madeById      String
  madeBy        User        @relation(fields: [madeById], references: [id])

  // Offer details
  amount        Decimal     @db.Decimal(12, 2)
  currency      String      @default("EUR")

  // Terms (flexible JSON for additional conditions)
  terms         Json?       // { "moveInDate": "2024-01-15", "includesFurniture": true, ... }
  message       String?     // Message accompanying the offer

  // Status tracking
  status        OfferStatus @default(PENDING)
  expiresAt     DateTime?   // Optional expiry for the offer
  respondedAt   DateTime?   // When seller/buyer responded

  // Counter-offer reference
  counterToId   String?     // If this is a counter-offer, reference to original offer

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([negotiationId])
  @@index([madeById])
  @@index([status])
}

// Transaction (PROD-093, PROD-095)
model Transaction {
  id              String            @id @default(uuid())
  negotiationId   String            @unique
  negotiation     Negotiation       @relation(fields: [negotiationId], references: [id])

  // Payment details
  amount          Decimal           @db.Decimal(12, 2)
  currency        String            @default("EUR")

  // Fee breakdown (PROD-095)
  platformFee     Decimal           @db.Decimal(10, 2) // Platform's fee
  platformFeeRate Decimal           @db.Decimal(5, 4)  // e.g., 0.0250 = 2.5%
  sellerAmount    Decimal           @db.Decimal(12, 2) // Amount seller receives

  // Stripe integration (PROD-094)
  stripePaymentIntentId String?     @unique
  stripeSessionId       String?

  // Status
  status          TransactionStatus @default(PENDING)

  // Payer info
  payerId         String
  payer           User              @relation(fields: [payerId], references: [id])

  // Timestamps
  paidAt          DateTime?
  failedAt        DateTime?
  refundedAt      DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([negotiationId])
  @@index([payerId])
  @@index([status])
  @@index([stripePaymentIntentId])
}

// ============================================
// MESSAGING (In-App Communication)
// ============================================

// Conversation - can be linked to a negotiation or property, or standalone
model Conversation {
  id              String    @id @default(uuid())

  // Optional link to negotiation for contextual conversations
  negotiationId   String?   @unique
  negotiation     Negotiation? @relation(fields: [negotiationId], references: [id], onDelete: SetNull)

  // Optional link to property for direct property inquiries
  propertyId      String?
  property        Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  // Conversation metadata
  subject         String?
  lastMessageAt   DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  messages        Message[]
  participants    ConversationParticipant[]

  @@index([negotiationId])
  @@index([propertyId])
  @@index([lastMessageAt])
}

// Tracks participants in a conversation with read status
model ConversationParticipant {
  id              String       @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  lastReadAt      DateTime?
  unreadCount     Int          @default(0)
  isArchived      Boolean      @default(false)
  isMuted         Boolean      @default(false)

  createdAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

// Individual message in a conversation
model Message {
  id              String       @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId        String
  sender          User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  type            MessageType  @default(TEXT)
  content         String

  isEdited        Boolean      @default(false)
  editedAt        DateTime?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================
// SERVICE PROVIDERS (PROD-060 to PROD-068)
// ============================================

// Service Provider Profile (PROD-060, PROD-061)
model ServiceProvider {
  id                  String                @id @default(uuid())
  userId              String
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Service type (PROD-060.2)
  serviceType         ServiceType

  // Application status (PROD-060.6)
  status              ServiceProviderStatus @default(PENDING)

  // Profile details (PROD-061.3) - flexible JSON structure per service type
  // Example: { "yearsExperience": 5, "specializations": ["residential", "commercial"], "hourlyRate": 50 }
  serviceDetails      Json?

  // Service area coverage (PROD-061.5)
  // Stored as JSON: { "city": "Budapest", "radius": 25, "country": "HU" }
  serviceArea         Json?

  // Supporting documents (PROD-060.5)
  // Array of { "type": "license", "url": "...", "name": "..." }
  documents           Json?

  // Profile completeness (PROD-061.4)
  profileCompleteness Int                   @default(0) // 0-100 percentage

  // Biography and qualifications
  bio                 String?
  qualifications      String?
  experience          String?

  // Verification
  isVerified          Boolean               @default(false)
  verifiedAt          DateTime?

  // Admin notes (for approval/rejection)
  adminNotes          String?
  reviewedAt          DateTime?
  reviewedById        String?

  // Relations
  availability        ProviderAvailability[]
  availabilityExceptions AvailabilityException[]
  receivedRequests    ServiceRequest[]      @relation("ProviderRequests")
  reviews             ProviderReview[]
  maintenanceAssignments MaintenanceRequest[] // Maintenance assignments (PROD-103)

  // Aggregated rating (PROD-068.6)
  averageRating       Float                 @default(0)
  totalReviews        Int                   @default(0)

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  @@unique([userId, serviceType]) // One profile per service type per user (PROD-061.2)
  @@index([userId])
  @@index([serviceType])
  @@index([status])
  @@index([averageRating])
}

// Provider Weekly Availability (PROD-062.1, PROD-062.2)
model ProviderAvailability {
  id            String          @id @default(uuid())
  providerId    String
  provider      ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  dayOfWeek     Int             // 0-6 (Sunday-Saturday)
  startTime     String          // "09:00" format
  endTime       String          // "17:00" format
  isAvailable   Boolean         @default(true)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([providerId, dayOfWeek])
  @@index([providerId])
}

// Availability Exceptions (PROD-062.3) - specific dates unavailable
model AvailabilityException {
  id            String          @id @default(uuid())
  providerId    String
  provider      ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  date          DateTime        @db.Date
  isAvailable   Boolean         @default(false) // false = unavailable, true = override to available
  reason        String?

  createdAt     DateTime        @default(now())

  @@unique([providerId, date])
  @@index([providerId])
  @@index([date])
}

// Service Request / Job Offer (PROD-063, PROD-064)
model ServiceRequest {
  id                String               @id @default(uuid())

  // Who is requesting the service
  requesterId       String
  requester         User                 @relation(fields: [requesterId], references: [id])

  // Which provider (can be null if broadcasting to matching providers)
  providerId        String?
  provider          ServiceProvider?     @relation("ProviderRequests", fields: [providerId], references: [id])

  // Service details
  serviceType       ServiceType
  propertyId        String?              // Optional link to property
  property          Property?            @relation(fields: [propertyId], references: [id])

  // Request details
  title             String
  description       String
  preferredDate     DateTime?
  preferredTimeSlot String?              // "09:00-12:00"
  urgency           String?              // "normal", "urgent", "flexible"

  // Location (can differ from property)
  address           String?
  city              String?
  country           String?

  // Budget
  budget            Decimal?             @db.Decimal(10, 2)
  currency          String               @default("EUR")

  // Status (PROD-064.4)
  status            ServiceRequestStatus @default(PENDING)

  // Provider response
  respondedAt       DateTime?
  rejectionReason   String?

  // Completion
  completedAt       DateTime?
  completionNotes   String?

  // Payment link (if applicable)
  transactionId     String?

  // Review reference
  review            ProviderReview?

  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([requesterId])
  @@index([providerId])
  @@index([serviceType])
  @@index([status])
  @@index([propertyId])
}

// Provider Reviews (PROD-068)
model ProviderReview {
  id            String          @id @default(uuid())

  providerId    String
  provider      ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  reviewerId    String
  reviewer      User            @relation(fields: [reviewerId], references: [id])

  // Must be linked to a completed service request (PROD-068.5)
  serviceRequestId String       @unique
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])

  // Rating (PROD-068.3)
  rating        Int             // 1-5 stars

  // Written review (PROD-068.4)
  title         String?
  comment       String?

  // Helpful votes
  helpfulCount  Int             @default(0)

  // Visibility
  isPublic      Boolean         @default(true)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([providerId])
  @@index([reviewerId])
  @@index([rating])
}

// ============================================
// MAINTENANCE REQUESTS (PROD-103)
// ============================================

model MaintenanceRequest {
  id                  String                    @id @default(uuid())

  // Property being maintained
  propertyId          String
  property            Property                  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Associated lease (tenant's lease)
  leaseId             String
  lease               Lease                     @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  // Tenant (requester)
  tenantId            String
  tenant              User                      @relation("TenantMaintenanceRequests", fields: [tenantId], references: [id])

  // Landlord (property owner)
  landlordId          String
  landlord            User                      @relation("LandlordMaintenanceRequests", fields: [landlordId], references: [id])

  // Assigned service provider (optional)
  assignedProviderId  String?
  assignedProvider    ServiceProvider?          @relation(fields: [assignedProviderId], references: [id])

  // Request details
  type                MaintenanceRequestType
  priority            MaintenancePriority       @default(NORMAL)
  title               String
  description         String
  attachmentUrls      String[]                  @default([])

  // Status & workflow
  status              MaintenanceRequestStatus  @default(SUBMITTED)
  rejectionReason     String?

  // Scheduling
  preferredDate       DateTime?
  scheduledDate       DateTime?
  scheduledTimeSlot   String?                   // e.g., "09:00-12:00"

  // Completion
  completionNotes     String?
  completionPhotos    String[]                  @default([])
  estimatedCost       Decimal?                  @db.Decimal(10, 2)
  actualCost          Decimal?                  @db.Decimal(10, 2)
  completedAt         DateTime?
  confirmedByTenant   Boolean                   @default(false)
  confirmedByLandlord Boolean                   @default(false)

  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt

  @@index([propertyId])
  @@index([leaseId])
  @@index([tenantId])
  @@index([landlordId])
  @@index([status])
  @@index([assignedProviderId])
}

// ============================================
// LEASE RENEWALS (PROD-105)
// ============================================

model LeaseRenewal {
  id                  String              @id @default(uuid())

  // Relationships
  leaseId             String
  lease               Lease               @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  landlordId          String
  landlord            User                @relation("LandlordLeaseRenewals", fields: [landlordId], references: [id])
  tenantId            String
  tenant              User                @relation("TenantLeaseRenewals", fields: [tenantId], references: [id])
  newLeaseId          String?             @unique
  newLease            Lease?              @relation("RenewalNewLease", fields: [newLeaseId], references: [id])

  // Renewal terms
  status              LeaseRenewalStatus  @default(PENDING)
  proposedStartDate   DateTime?           // New lease start date
  proposedEndDate     DateTime?           // New lease end date
  proposedRentAmount  Decimal?            @db.Decimal(12, 2)
  proposedTerms       String?             // Additional terms/notes
  offerExpiresAt      DateTime?           // Deadline for tenant response

  // Tracking
  reminderSentAt      DateTime?           // When 60-day reminder was sent
  offerSentAt         DateTime?           // When offer was sent to tenant
  respondedAt         DateTime?           // When tenant responded
  declineReason       String?             // Optional reason if declined

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([leaseId])
  @@index([landlordId])
  @@index([tenantId])
  @@index([status])
}
